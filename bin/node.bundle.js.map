{"version":3,"sources":["webpack:///webpack/bootstrap 675ddd23a422d9546eb6","webpack:///external \"lodash\"","webpack:///external \"bluebird\"","webpack:///./src/outgoing.js","webpack:///./src/actions.js","webpack:///./src/users.js","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///external \"path\"","webpack:///external \"fs\"","webpack:///external \"uuid\"","webpack:///./src/messenger.js","webpack:///./src/db.js","webpack:///external \"botpress\"","webpack:///external \"eventemitter2\"","webpack:///external \"crypto\"","webpack:///external \"node-fetch\"","webpack:///external \"body-parser\"","webpack:///./src/incoming.js","webpack:///external \"lru-cache\"","webpack:///./src/umm.js","webpack:///external \"util\"","webpack:///./src/botpress-messenger.config.yml"],"names":["handlePromise","next","promise","then","res","catch","err","handleText","event","messenger","sendTextMessage","raw","to","message","quick_replies","handleAttachment","sendAttachment","type","url","handleTemplate","sendTemplate","payload","handleTyping","sendTypingIndicator","typing","handleSeen","sendAction","handleGetStarted","enabled","setGetStartedButton","postback","deleteGetStartedButton","handlePersistentMenu","delete","deletePersistentMenu","setPersistentMenu","elements","handleGreetingText","text","setGreetingText","deleteGreetingText","handleWhitelistedDomains","setWhitelistedDomains","domains","module","exports","pending","create","resolve","reject","r","rj","messageId","Date","toISOString","Math","random","newEvent","Object","assign","_promise","_resolve","_reject","__id","obj","validateUserId","userId","test","Error","validateText","length","validateQuickReplies","isArray","forEach","validateQuickReply","quick_reply","title","validateTyping","isBoolean","isNumber","validateAttachmentType","includes","toLowerCase","validateUrl","validateTemplatePayload","isPlainObject","template_type","validatePersistentMenu","element","createText","options","platform","waitRead","waitDelivery","createAttachment","isNull","attachmentId","isReusable","createTemplate","createTyping","createSeen","createPersistentMenu","createGreetingText","createGetStarted","createWhitelistedDomains","every","isString","_","require","bp","db","get","knex","where","user","dbEntryToProfile","getUserProfile","id","profile","saveUser","profileToDbEntry","getOrFetchUserProfile","users","map","getAllUsers","gender","timezone","locale","picture_url","profile_pic","first_name","last_name","outgoingPending","outgoingMiddleware","setValue","args","message_id","timestamp","getTime","mid","method","apply","initializeMessenger","configurator","loadAll","config","configErrors","getConfigErrors","logger","warn","notifications","send","level","connect","updateSettings","error","createConfigFile","name","file","join","projectLocation","existsSync","writeFileSync","applicationID","required","default","env","accessToken","appSecret","verifyToken","v4","validated","connected","hostname","homepage","displayGetStarted","greetingMessage","persistentMenu","persistentMenuItems","validation","v","composerInputDisabled","automaticallyMarkAsRead","targetAudience","targetAudienceOpenToSome","targetAudienceCloseToSome","trustedDomains","autoRespondGetStarted","autoResponse","autoResponseOption","autoResponseText","autoResponsePostback","paymentTesters","chatExtensionHomeUrl","chatExtensionInTest","chatExtensionShowShareButton","webhookSubscriptionFields","init","__dirname","middlewares","register","order","handler","description","forIn","action","applyFn","msg","arguments","fn","deprecate","lts","referenceUrl","sendName","replace","sendOutgoing","ready","_internal","router","getRouter","req","getConfig","post","setConfig","body","saveAll","sendStatus","status","disconnect","sendValidationRequest","json","packageJSON","JSON","parse","readFileSync","values","deletePaymentTester","payment_tester","_getPage","Promise","EventEmitter","crypto","fetch","bodyParser","normalizeString","str","toUpperCase","Messenger","k","initialize","app","originalUrl","use","verify","_verifyRequestSignature","bind","_initWebhook","errors","value","key","isNil","isEmpty","push","_setupNewWebhook","_subscribePage","_unsubscribePage","recipientId","quickReplies","formattedQuickReplies","_formatQuickReplies","sendMessage","buttons","formattedButtons","_formatButtons","attachment","is_reusable","attachment_id","hasAttachment","getAttachment","addAttachment","sendRequest","recipient","sender_action","autoTimeout","timeout","headers","stringify","object_id","object","field","custom_fields","page_id","access_token","_handleFacebookResponse","endpoint","_handleEvent","token","response","milliseconds","isNaN","min","before","delay","console","log","setting","target_audience","audience_type","countriesWhitelist","split","countries","whitelist","countriesBlacklist","blacklist","createTargetAudienceSetting","indexOf","fields","whitelisted_domains","sendThreadRequest","setting_type","greeting","on","thread_state","call_to_actions","persistent_menu","composer_input_disabled","home_url","in_test","show_share","show_string","deleteChatExtensionHomeUrlSetting","createChatExtensionHomeUrlSetting","tester","createPaymentTesterSetting","deletePaymentTesterSetting","updateGetStarted","updateGreetingText","items","_reformatPersistentMenuItems","updatePersistentMenu","updateTargetAudience","setTargetAudience","updateTrustedDomains","updateChatExtensionHomeUrl","deleteChatExtensionHomeUrl","setChatExtensionHomeUrl","updatePaymentTesters","setPaymentTesters","thrown","contextifyError","context","factory","button","reply","content_type","image_url","emit","sender","errorMessage","statusText","finally","query","data","entry","messaging","is_echo","broadcastEchoes","_handleQuickReplyEvent","_handleMessageEvent","attachments","_handleAttachmentEvent","_handlePostbackEvent","delivery","read","account_linking","optin","referral","payment","buf","path","signature","hash","expectedHash","createHmac","update","digest","item","oAuthUrl","callback_url","verify_token","createTableIfNotExists","table","string","primary","insert","select","ret","count","messagesCache","max","maxAge","preprocessEvent","has","alreadyProcessed","set","e","sendIncoming","att","mConfig","sendText","mids","watermark","toString","authorization_code","ref","QUICK_REPLY_PAYLOAD","processButtons","blocName","processQuickReplies","qrs","qr","exec","startsWith","amendButtons","mapValues","getUserId","substr","processOutgoing","instruction","ins","optionsList","pick","prop","attr","strRep","inspect","getTemplates","template","at","umm","registerConnector","templates"],"mappings":";;AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;AAEA;AACA;;;;;;;AC7DA,mC;;;;;;ACAA,qC;;;;;;;;;ACAA,IAAMA,gBAAgB,SAAhBA,aAAgB,CAACC,IAAD,EAAOC,OAAP,EAAmB;AACvC,SAAOA,QAAQC,IAAR,CAAa,eAAO;AACzBF;AACA,WAAOG,GAAP;AACD,GAHM,EAINC,KAJM,CAIA,eAAO;AACZJ,SAAKK,GAAL;AACA,UAAMA,GAAN;AACD,GAPM,CAAP;AAQD,CATD;;AAWA,IAAMC,aAAa,SAAbA,UAAa,CAACC,KAAD,EAAQP,IAAR,EAAcQ,SAAd,EAA4B;AAC7C,SAAOT,cAAcC,IAAd,EAAoBQ,UAAUC,eAAV,CACzBF,MAAMG,GAAN,CAAUC,EADe,EAEzBJ,MAAMG,GAAN,CAAUE,OAFe,EAGzBL,MAAMG,GAAN,CAAUG,aAHe,EAIzBN,MAAMG,GAJmB,CAApB,CAAP;AAKD,CAND;;AAQA,IAAMI,mBAAmB,SAAnBA,gBAAmB,CAACP,KAAD,EAAQP,IAAR,EAAcQ,SAAd,EAA4B;AACnD,SAAOT,cAAcC,IAAd,EAAoBQ,UAAUO,cAAV,CACzBR,MAAMG,GAAN,CAAUC,EADe,EAEzBJ,MAAMG,GAAN,CAAUM,IAFe,EAGzBT,MAAMG,GAAN,CAAUO,GAHe,EAIzBV,MAAMG,GAAN,CAAUG,aAJe,EAKzBN,MAAMG,GALmB,CAApB,CAAP;AAMD,CAPD;;AASA,IAAMQ,iBAAiB,SAAjBA,cAAiB,CAACX,KAAD,EAAQP,IAAR,EAAcQ,SAAd,EAA4B;AACjD,SAAOT,cAAcC,IAAd,EAAoBQ,UAAUW,YAAV,CACzBZ,MAAMG,GAAN,CAAUC,EADe,EAEzBJ,MAAMG,GAAN,CAAUU,OAFe,EAGzBb,MAAMG,GAHmB,CAApB,CAAP;AAID,CALD;;AAOA,IAAMW,eAAe,SAAfA,YAAe,CAACd,KAAD,EAAQP,IAAR,EAAcQ,SAAd,EAA4B;AAC/C,SAAOT,cAAcC,IAAd,EAAoBQ,UAAUc,mBAAV,CACzBf,MAAMG,GAAN,CAAUC,EADe,EAEzBJ,MAAMG,GAAN,CAAUa,MAFe,CAApB,CAAP;AAGD,CAJD;;AAMA,IAAMC,aAAa,SAAbA,UAAa,CAACjB,KAAD,EAAQP,IAAR,EAAcQ,SAAd,EAA4B;AAC7C,SAAOT,cAAcC,IAAd,EACLQ,UAAUiB,UAAV,CAAqBlB,MAAMG,GAAN,CAAUC,EAA/B,EAAmC,WAAnC,CADK,CAAP;AAED,CAHD;;AAKA,IAAMe,mBAAmB,SAAnBA,gBAAmB,CAACnB,KAAD,EAAQP,IAAR,EAAcQ,SAAd,EAA4B;AACnD,MAAID,MAAMG,GAAN,CAAUiB,OAAd,EAAuB;AACrB,WAAO5B,cAAcC,IAAd,EACLQ,UAAUoB,mBAAV,CAA8BrB,MAAMG,GAAN,CAAUmB,QAAxC,CADK,CAAP;AAED,GAHD,MAGO;AACL,WAAO9B,cAAcC,IAAd,EAAoBQ,UAAUsB,sBAAV,EAApB,CAAP;AACD;AACF,CAPD;;AASA,IAAMC,uBAAuB,SAAvBA,oBAAuB,CAACxB,KAAD,EAAQP,IAAR,EAAcQ,SAAd,EAA4B;AACvD,MAAID,MAAMG,GAAN,CAAUsB,MAAd,EAAsB;AACpB,WAAOjC,cAAcC,IAAd,EAAoBQ,UAAUyB,oBAAV,EAApB,CAAP;AACD,GAFD,MAEO;AACL,WAAOlC,cAAcC,IAAd,EACLQ,UAAU0B,iBAAV,CAA4B3B,MAAMG,GAAN,CAAUyB,QAAtC,CADK,CAAP;AAED;AACF,CAPD;;AASA,IAAMC,qBAAqB,SAArBA,kBAAqB,CAAC7B,KAAD,EAAQP,IAAR,EAAcQ,SAAd,EAA4B;AACrD,MAAID,MAAMG,GAAN,CAAU2B,IAAd,EAAoB;AAClB,WAAOtC,cAAcC,IAAd,EACLQ,UAAU8B,eAAV,CAA0B/B,MAAMG,GAAN,CAAU2B,IAApC,CADK,CAAP;AAED,GAHD,MAGO;AACL,WAAOtC,cAAcC,IAAd,EAAoBQ,UAAU+B,kBAAV,CAA6BhC,MAAMG,GAAN,CAAU2B,IAAvC,CAApB,CAAP;AACD;AACF,CAPD;;AASA,IAAMG,2BAA2B,SAA3BA,wBAA2B,CAACjC,KAAD,EAAQP,IAAR,EAAcQ,SAAd,EAA4B;AAC3D,SAAOT,cAAcC,IAAd,EACLQ,UAAUiC,qBAAV,CAAgClC,MAAMG,GAAN,CAAUgC,OAA1C,CADK,CAAP;AAED,CAHD;;AAKAC,OAAOC,OAAP,GAAiB;AACf,UAAQtC,UADO;AAEf,gBAAcQ,gBAFC;AAGf,cAAYI,cAHG;AAIf,YAAUG,YAJK;AAKf,UAAQG,UALO;AAMf,mBAAiBY,kBANF;AAOf,qBAAmBL,oBAPJ;AAQf,yBAAuBS,wBARR;AASf,iBAAed,gBATA;AAUfmB,WAAS;AAVM,CAAjB,C;;;;;;;;;AC9EA;;;;AACA;;;;AACA;;;;;;AAEA,IAAMC,SAAS,SAATA,MAAS,MAAO;AACpB,MAAIC,UAAU,IAAd;AACA,MAAIC,SAAS,IAAb;AACA,MAAM/C,UAAU,uBAAY,UAACgD,CAAD,EAAIC,EAAJ,EAAW;AACrCH,cAAUE,CAAV;AACAD,aAASE,EAAT;AACD,GAHe,CAAhB;;AAKA,MAAMC,YAAY,IAAIC,IAAJ,GAAWC,WAAX,KAA2BC,KAAKC,MAAL,EAA7C;;AAEA,MAAMC,WAAWC,OAAOC,MAAP,CAAc;AAC7BC,cAAU1D,OADmB;AAE7B2D,cAAUb,OAFmB;AAG7Bc,aAASb,MAHoB;AAI7Bc,UAAMX;AAJuB,GAAd,EAKdY,GALc,CAAjB;;AAOA,qBAASlB,OAAT,CAAiBM,SAAjB,IAA8B;AAC5B5C,WAAOiD,QADqB;AAE5BT,aAASA,OAFmB;AAG5BC,YAAQA;AAHoB,GAA9B;;AAMA,SAAOQ,QAAP;AACD,CAxBD;;AA0BA,IAAMQ,iBAAiB,SAAjBA,cAAiB,CAACC,MAAD,EAAY;AACjC,MAAI,CAAC,SAASC,IAAT,CAAcD,MAAd,CAAL,EAA4B;AAC1B,UAAM,IAAIE,KAAJ,CAAU,gBAAV,CAAN;AACD;AACF,CAJD;;AAMA,IAAMC,eAAe,SAAfA,YAAe,CAAC/B,IAAD,EAAU;AAC7B,MAAI,OAAOA,IAAP,KAAiB,QAAjB,IAA6BA,KAAKgC,MAAL,GAAc,GAA/C,EAAoD;AAClD,UAAM,IAAIF,KAAJ,CAAU,4CAAV,CAAN;AACD;AACF,CAJD;;AAMA,IAAMG,uBAAuB,SAAvBA,oBAAuB,CAACzD,aAAD,EAAmB;AAC9C,MAAI,CAAC,iBAAE0D,OAAF,CAAU1D,aAAV,CAAL,EAA+B;AAC7B,UAAM,IAAIsD,KAAJ,CAAU,gCAAV,CAAN;AACD;;AAED,mBAAEK,OAAF,CAAU3D,aAAV,EAAyB4D,kBAAzB;AACD,CAND;;AAQA,IAAMA,qBAAqB,SAArBA,kBAAqB,CAACC,WAAD,EAAiB;AAC1C,MAAI,OAAOA,WAAP,KAAwB,QAA5B,EAAsC;AACpC,QAAI,CAACA,WAAD,IAAgB,OAAOA,YAAYC,KAAnB,KAA8B,QAAlD,EAA4D;AAC1D,YAAM,IAAIR,KAAJ,CAAU,qDACd,eADI,CAAN;AAED;AACF;AACF,CAPD;;AASA,IAAMS,iBAAiB,SAAjBA,cAAiB,CAACrD,MAAD,EAAY;AACjC,MAAI,CAAC,iBAAEsD,SAAF,CAAYtD,MAAZ,CAAD,IAAwB,CAAC,iBAAEuD,QAAF,CAAWvD,MAAX,CAA7B,EAAiD;AAC/C,UAAM,IAAI4C,KAAJ,CAAU,6CAAV,CAAN;AACD;AACF,CAJD;;AAMA,IAAMY,yBAAyB,SAAzBA,sBAAyB,CAAC/D,IAAD,EAAU;AACvC,MAAI,OAAOA,IAAP,KAAiB,QAArB,EAA+B;AAC7B,UAAM,IAAImD,KAAJ,CAAU,uCAAV,CAAN;AACD;;AAED,MAAI,CAAC,iBAAEa,QAAF,CAAW,CAAC,OAAD,EAAU,OAAV,EAAmB,OAAnB,EAA4B,MAA5B,CAAX,EAAgDhE,KAAKiE,WAAL,EAAhD,CAAL,EAA0E;AACxE,UAAM,IAAId,KAAJ,CAAU,yBAAV,CAAN;AACD;AACF,CARD;;AAUA,IAAMe,cAAc,SAAdA,WAAc,CAACjE,GAAD,EAAS;AAC3B,MAAI,OAAOA,GAAP,KAAgB,QAApB,EAA8B;AAC5B,UAAM,IAAIkD,KAAJ,CAAU,6BAAV,CAAN;AACD;AACF,CAJD;;AAMA,IAAMgB,0BAA0B,SAA1BA,uBAA0B,CAAC/D,OAAD,EAAa;AAC3C,MAAI,CAAC,iBAAEgE,aAAF,CAAgBhE,OAAhB,CAAL,EAA+B;AAC7B,UAAM,IAAI+C,KAAJ,CAAU,yCAAV,CAAN;AACD;;AAED,MAAI,OAAO/C,QAAQiE,aAAf,KAAkC,QAAtC,EAAgD;AAC9C,UAAM,IAAIlB,KAAJ,CAAU,6BAAV,CAAN;AACD;AACF,CARD;;AAUA,IAAMmB,yBAAyB,SAAzBA,sBAAyB,CAACnD,QAAD,EAAc;AAC3C,MAAI,CAAC,iBAAEoC,OAAF,CAAUpC,QAAV,CAAL,EAA0B;AACxB,UAAM,IAAIgC,KAAJ,CAAU,kCAAV,CAAN;AACD;;AAED,mBAAEK,OAAF,CAAUrC,QAAV,EAAoB,UAACoD,OAAD,EAAa;AAC/B,QAAI,CAAC,iBAAEH,aAAF,CAAgBG,OAAhB,CAAL,EAA+B;AAC7B,YAAM,IAAIpB,KAAJ,CAAU,uCAAV,CAAN;AACD;AACF,GAJD;AAKD,CAVD;;AAYA,IAAMqB,aAAa,SAAbA,UAAa,CAACvB,MAAD,EAAS5B,IAAT,EAAeoD,OAAf,EAA2B;AAC5CzB,iBAAeC,MAAf;AACAG,eAAa/B,IAAb;;AAEA,MAAIoD,WAAWA,QAAQ5E,aAAvB,EAAsC;AACpCyD,yBAAqBmB,QAAQ5E,aAA7B;AACD;;AAED,MAAI4E,WAAWA,QAAQlE,MAAvB,EAA+B;AAC7BqD,mBAAea,QAAQlE,MAAvB;AACD;;AAED,SAAOuB,OAAO;AACZ4C,cAAU,UADE;AAEZ1E,UAAM,MAFM;AAGZqB,UAAMA,IAHM;AAIZ3B,SAAK;AACHC,UAAIsD,MADD;AAEHrD,eAASyB,IAFN;AAGHd,cAASkE,WAAWA,QAAQlE,MAHzB;AAIHV,qBAAe4E,WAAWA,QAAQ5E,aAJ/B;AAKH8E,gBAAUF,WAAWA,QAAQE,QAL1B;AAMHC,oBAAcH,WAAWA,QAAQG;AAN9B;AAJO,GAAP,CAAP;AAaD,CAzBD;;AA2BA,IAAMC,mBAAmB,SAAnBA,gBAAmB,CAAC5B,MAAD,EAASjD,IAAT,EAAeC,GAAf,EAAoBwE,OAApB,EAAgC;AACvDzB,iBAAeC,MAAf;AACAc,yBAAuB/D,IAAvB;;AAEA,MAAK,iBAAE8E,MAAF,CAAS7E,GAAT,KAAiB,EAAEwE,WAAWA,QAAQM,YAArB,CAAtB,EAA2D;AACzD,UAAM,IAAI5B,KAAJ,CAAU,kEAAV,CAAN;AACD,GAFD,MAGK,IAAKsB,WAAWA,QAAQM,YAAxB,EAAuC;AAC1C3B,iBAAaqB,QAAQM,YAArB;AACD,GAFI,MAGA;AACHb,gBAAYjE,GAAZ;AACD;;AAED,MAAIwE,WAAWA,QAAQ5E,aAAvB,EAAsC;AACpCyD,yBAAqBmB,QAAQ5E,aAA7B;AACD;;AAED,MAAI4E,WAAWA,QAAQlE,MAAvB,EAA+B;AAC7BqD,mBAAea,QAAQlE,MAAvB;AACD;;AAED,SAAOuB,OAAO;AACZ4C,cAAU,UADE;AAEZ1E,UAAM,YAFM;AAGZqB,UAAM,iBAAiBrB,IAAjB,GAAwB,MAAxB,GAAiCC,GAH3B;AAIZP,SAAK;AACHC,UAAIsD,MADD;AAEHjD,YAAMA,IAFH;AAGHC,WAAKA,GAHF;AAIH+E,kBAAaP,WAAWA,QAAQO,UAJ7B;AAKHD,oBAAeN,WAAWA,QAAQM,YAL/B;AAMHxE,cAASkE,WAAWA,QAAQlE,MANzB;AAOHV,qBAAe4E,WAAWA,QAAQ5E,aAP/B;AAQH8E,gBAAUF,WAAWA,QAAQE,QAR1B;AASHC,oBAAcH,WAAWA,QAAQG;AAT9B;AAJO,GAAP,CAAP;AAgBD,CAtCD;;AAwCA,IAAMK,iBAAiB,SAAjBA,cAAiB,CAAChC,MAAD,EAAS7C,OAAT,EAAkBqE,OAAlB,EAA8B;AACnDzB,iBAAeC,MAAf;AACAkB,0BAAwB/D,OAAxB;;AAEA,MAAIqE,WAAWA,QAAQlE,MAAvB,EAA+B;AAC7BqD,mBAAea,QAAQlE,MAAvB;AACD;;AAED,SAAOuB,OAAO;AACZ4C,cAAU,UADE;AAEZ1E,UAAM,UAFM;AAGZqB,UAAM,eAAejB,QAAQiE,aAAvB,GAAuC,GAHjC;AAIZ3E,SAAK;AACHC,UAAIsD,MADD;AAEH7C,eAASA,OAFN;AAGHG,cAASkE,WAAWA,QAAQlE,MAHzB;AAIHoE,gBAAUF,WAAWA,QAAQE,QAJ1B;AAKHC,oBAAcH,WAAWA,QAAQG;AAL9B;AAJO,GAAP,CAAP;AAYD,CApBD;;AAsBA,IAAMM,eAAe,SAAfA,YAAe,CAACjC,MAAD,EAAS1C,MAAT,EAAoB;AACvCyC,iBAAeC,MAAf;AACAW,iBAAerD,MAAf;;AAEA,SAAOuB,OAAO;AACZ4C,cAAU,UADE;AAEZ1E,UAAM,QAFM;AAGZqB,UAAM,aAAad,MAHP;AAIZb,SAAK;AACHC,UAAIsD,MADD;AAEH1C,cAAQA;AAFL;AAJO,GAAP,CAAP;AASD,CAbD;;AAeA,IAAM4E,aAAa,SAAbA,UAAa,CAAClC,MAAD,EAAY;AAC7BD,iBAAeC,MAAf;;AAEA,SAAOnB,OAAO;AACZ4C,cAAU,UADE;AAEZ1E,UAAM,MAFM;AAGZqB,UAAM,cAHM;AAIZ3B,SAAK;AACHC,UAAIsD;AADD;AAJO,GAAP,CAAP;AAQD,CAXD;;AAaA,IAAMmC,uBAAuB,SAAvBA,oBAAuB,CAACjE,QAAD,EAAc;AACzC,MAAI,CAACA,QAAL,EAAe;AACb,WAAOW,OAAO;AACZ4C,gBAAU,UADE;AAEZ1E,YAAM,iBAFM;AAGZqB,YAAM,4BAHM;AAIZ3B,WAAK;AACHsB,gBAAQ;AADL;AAJO,KAAP,CAAP;AAQD;;AAEDsD,yBAAuBnD,QAAvB;AACA,SAAOW,OAAO;AACZ4C,cAAU,UADE;AAEZ1E,UAAM,iBAFM;AAGZqB,UAAM,0BAA0BF,SAASkC,MAAnC,GAA4C,QAHtC;AAIZ3D,SAAK;AACHsB,cAAQ,KADL;AAEHG,gBAAUA;AAFP;AAJO,GAAP,CAAP;AASD,CAtBD;;AAwBA,IAAMkE,qBAAqB,SAArBA,kBAAqB,CAAChE,IAAD,EAAU;AACnC,MAAIA,QAAQA,KAAKgC,MAAL,GAAc,GAA1B,EAA+B;AAC7B,UAAM,IAAIF,KAAJ,CAAU,2CAAV,CAAN;AACD;;AAED,SAAOrB,OAAO;AACZ4C,cAAU,UADE;AAEZ1E,UAAM,eAFM;AAGZqB,UAAM,wBAAwBA,IAHlB;AAIZ3B,SAAK;AACH2B,YAAMA;AADH;AAJO,GAAP,CAAP;AAQD,CAbD;;AAeA,IAAMiE,mBAAmB,SAAnBA,gBAAmB,CAACzE,QAAD,EAAc;AACrC,SAAOiB,OAAO;AACZ4C,cAAU,UADE;AAEZ1E,UAAM,aAFM;AAGZqB,UAAM,iCAAiC,CAAC,CAACR,QAH7B;AAIZnB,SAAK;AACHiB,eAAS,CAAC,CAACE,QADR;AAEHA,gBAAUA;AAFP;AAJO,GAAP,CAAP;AASD,CAVD;;AAYA,IAAM0E,2BAA2B,SAA3BA,wBAA2B,CAAC7D,OAAD,EAAa;AAC5C,MAAIA,WAAW,CAAC,iBAAE8D,KAAF,CAAQ9D,OAAR,EAAiB,iBAAE+D,QAAnB,CAAhB,EAA8C;AAC5C,UAAM,IAAItC,KAAJ,CAAU,yCAAV,CAAN;AACD;;AAED,SAAOrB,OAAO;AACZ4C,cAAU,UADE;AAEZ1E,UAAM,qBAFM;AAGZqB,UAAM,6BAHM;AAIZ3B,SAAK;AACHgC,eAASA;AADN;AAJO,GAAP,CAAP;AAQD,CAbD;;AAeAC,OAAOC,OAAP,GAAiB;AACf4C,wBADe;AAEfK,oCAFe;AAGfI,gCAHe;AAIfC,4BAJe;AAKfC,wBALe;AAMfG,oCANe;AAOfF,4CAPe;AAQfC,wCARe;AASfE;AATe,CAAjB,C;;;;;;;;;;;AC9RA,IAAMG,IAAI,mBAAAC,CAAQ,CAAR,CAAV;;AAEAhE,OAAOC,OAAP,GAAiB,UAASgE,EAAT,EAAapG,SAAb,EAAwB;AAAA;AAAA,yDA2BvC,iBAAqCyD,MAArC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBACqB2C,GAAGC,EAAH,CAAMC,GAAN,EADrB;;AAAA;AACQC,kBADR;AAAA;AAAA,qBAGqBA,KAAK,OAAL,EAChBC,KADgB,CACV,EAAEtB,UAAU,UAAZ,EAAwB,UAAUzB,MAAlC,EADU,EAEhB/D,IAFgB,GAET4G,GAFS,CAEL,CAFK,EAEF5G,IAFE,EAHrB;;AAAA;AAGQ+G,kBAHR;;AAAA,mBAOMA,IAPN;AAAA;AAAA;AAAA;;AAAA,+CAQWC,iBAAiBD,IAAjB,CARX;;AAAA;AAAA,4BAWkBxD,MAXlB;AAAA;AAAA,qBAWsCjD,UAAU2G,cAAV,CAAyBlD,MAAzB,CAXtC;;AAAA;AAAA;AAAA,4BAWwE,EAAEmD,IAAInD,MAAN,EAXxE;AAWQoD,qBAXR,eAWyB3D,MAXzB;AAAA;AAAA,qBAYQkD,GAAGC,EAAH,CAAMS,QAAN,CAAeC,iBAAiBF,OAAjB,CAAf,CAZR;;AAAA;AAAA,+CAcSA,OAdT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KA3BuC;;AAAA,oBA2BxBG,qBA3BwB;AAAA;AAAA;AAAA;;AAAA;AAAA,0DA4CvC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBACqBZ,GAAGC,EAAH,CAAMC,GAAN,EADrB;;AAAA;AACQC,kBADR;AAAA;AAAA,qBAGsBA,KAAK,OAAL,EACjBC,KADiB,CACX,EAAEtB,UAAU,UAAZ,EADW,EAEjBxF,IAFiB,EAHtB;;AAAA;AAGQuH,mBAHR;AAAA,gDAOS,CAACA,SAAS,EAAV,EAAcC,GAAd,CAAkBR,gBAAlB,CAPT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KA5CuC;;AAAA,oBA4CxBS,WA5CwB;AAAA;AAAA;AAAA;;AAEvC,WAASJ,gBAAT,CAA0BF,OAA1B,EAAmC;AACjC,WAAO;AACLD,UAAIC,QAAQD,EADP;AAEL1B,gBAAU,UAFL;AAGLkC,cAAQP,QAAQO,MAHX;AAILC,gBAAUR,QAAQQ,QAJb;AAKLC,cAAQT,QAAQS,MALX;AAMLC,mBAAaV,QAAQW,WANhB;AAOLC,kBAAYZ,QAAQY,UAPf;AAQLC,iBAAWb,QAAQa;AARd,KAAP;AAUD;;AAED,WAAShB,gBAAT,CAA0BL,EAA1B,EAA8B;AAC5B,WAAO;AACLe,cAAQf,GAAGe,MADN;AAELC,gBAAUhB,GAAGgB,QAFR;AAGLC,cAAQjB,GAAGiB,MAHN;AAILE,mBAAanB,GAAGkB,WAJX;AAKLE,kBAAYpB,GAAGoB,UALV;AAMLC,iBAAWrB,GAAGqB,SANT;AAOLd,UAAIP,GAAG5C;AAPF,KAAP;AASD;;AA6BD,SAAO,EAAEuD,4CAAF,EAAyBG,wBAAzB,EAAP;AACD,CAvDD,C;;;;;;;;;;;;;;;;ACAA;;;;AAEA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;;;AAEA,IAAInH,YAAY,IAAhB,C,CApBA;;AAqBA,IAAM2H,kBAAkB,mBAAStF,OAAjC;;AAEA,IAAI4E,QAAQ,IAAZ;;AAEA,IAAMW,qBAAqB,SAArBA,kBAAqB,CAAC7H,KAAD,EAAQP,IAAR,EAAiB;AAC1C,MAAIO,MAAMmF,QAAN,KAAmB,UAAvB,EAAmC;AACjC,WAAO1F,MAAP;AACD;;AAED,MAAI,CAAC,mBAASO,MAAMS,IAAf,CAAL,EAA2B;AACzB,WAAOhB,KAAK,6BAA6BO,MAAMS,IAAxC,CAAP;AACD;;AAED,MAAMqH,WAAW,SAAXA,QAAW;AAAA,WAAU,YAAa;AAAA,wCAATC,IAAS;AAATA,YAAS;AAAA;;AACtC,UAAI/H,MAAMuD,IAAN,IAAcqE,gBAAgB5H,MAAMuD,IAAtB,CAAlB,EAA+C;;AAE7C,YAAIwE,QAAQA,KAAK,CAAL,CAAR,IAAmBA,KAAK,CAAL,EAAQC,UAA/B,EAA2C;AACzCJ,0BAAgB5H,MAAMuD,IAAtB,EAA4B0E,SAA5B,GAAwC,IAAIpF,IAAJ,GAAWqF,OAAX,KAAuB,IAA/D;AACAN,0BAAgB5H,MAAMuD,IAAtB,EAA4B4E,GAA5B,GAAkCJ,KAAK,CAAL,EAAQC,UAA1C;AACD;;AAED,YAAII,WAAW,SAAX,KAAyBpI,MAAMG,GAAN,CAAUkF,YAAV,IAA0BrF,MAAMG,GAAN,CAAUiF,QAA7D,CAAJ,EAA4E;AAC1E;AACD,SAFD,MAEO;AACLwC,0BAAgB5H,MAAMuD,IAAtB,EAA4B6E,MAA5B,EAAoCC,KAApC,CAA0C,IAA1C,EAAgDN,IAAhD;AACA,iBAAOH,gBAAgB5H,MAAMuD,IAAtB,CAAP;AACD;AACF;AACF,KAfgB;AAAA,GAAjB;;AAiBA,qBAASvD,MAAMS,IAAf,EAAqBT,KAArB,EAA4BP,IAA5B,EAAkCQ,SAAlC,EACCN,IADD,CACMmI,SAAS,SAAT,CADN,EAC2BA,SAAS,QAAT,CAD3B;AAED,CA5BD;;AA8BA,IAAMQ,sBAAsB,SAAtBA,mBAAsB,CAACjC,EAAD,EAAKkC,YAAL,EAAsB;AAChD,SAAOA,aAAaC,OAAb,GACN7I,IADM,CACD,kBAAU;AACdM,gBAAY,wBAAcoG,EAAd,EAAkBoC,MAAlB,CAAZ;;AAEAvB,YAAQ,qBAAMb,EAAN,EAAUpG,SAAV,CAAR;;AAEA,QAAMyI,eAAezI,UAAU0I,eAAV,EAArB;AACA,QAAMvH,UAAUqH,OAAOrH,OAAvB;;AAEA,QAAI,CAACA,OAAL,EAAc;AACZ,aAAOiF,GAAGuC,MAAH,CAAUC,IAAV,CAAe,2CAAf,CAAP;AACD;;AAED,QAAIH,aAAa5E,MAAjB,EAAyB;AAAA;AAAA;AAAA;;AAAA;AACvB,6BAAgB4E,YAAhB,8HAA8B;AAAA,cAArB5I,GAAqB;;AAC5BuG,aAAGuC,MAAH,CAAUC,IAAV,CAAe,0BAA0B/I,IAAIO,OAA7C;AACD;AAHsB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAKvB,aAAOgG,GAAGyC,aAAH,CAAiBC,IAAjB,CAAsB;AAC3BC,eAAO,OADoB;AAE3B3I,iBAAS;AAFkB,OAAtB,CAAP;AAID;;AAED,WAAOJ,UAAUgJ,OAAV,GACNtJ,IADM,CACD;AAAA,aAAMM,UAAUiJ,cAAV,EAAN;AAAA,KADC,EAENvJ,IAFM,CAED;AAAA,aAAM0G,GAAGyC,aAAH,CAAiBC,IAAjB,CAAsB;AAChCC,eAAO,SADyB;AAEhC3I,iBAAS;AAFuB,OAAtB,CAAN;AAAA,KAFC,EAMNR,KANM,CAMA,eAAO;AACZwG,SAAGuC,MAAH,CAAUO,KAAV,CAAgBrJ,GAAhB;AACA,aAAOuG,GAAGyC,aAAH,CAAiBC,IAAjB,CAAsB;AAC3BC,eAAO,OADoB;AAE3B3I,iBAAS;AAFkB,OAAtB,CAAP;AAID,KAZM,CAAP;AAcD,GAtCM,CAAP;AAuCD,CAxCD;;AA0CA,IAAM+I,mBAAmB,SAAnBA,gBAAmB,CAAC/C,EAAD,EAAQ;AAC/B,MAAMgD,OAAO,+BAAb;AACA,MAAMC,OAAO,eAAKC,IAAL,CAAUlD,GAAGmD,eAAb,EAA8BH,IAA9B,CAAb;;AAEA,MAAI,CAAC,aAAGI,UAAH,CAAcH,IAAd,CAAL,EAA0B;AACxB,iBAAGI,aAAH,CAAiBJ,IAAjB;;AAEAjD,OAAGyC,aAAH,CAAiBC,IAAjB,CAAsB;AACpBC,aAAO,MADa;AAEpB3I,eAASgJ,OAAO;AAFI,KAAtB;AAID;AACF,CAZD;;AAcAjH,OAAOC,OAAP,GAAiB;;AAEfoG,UAAQ;AACNkB,mBAAe,EAAElJ,MAAM,QAAR,EAAkBmJ,UAAU,IAA5B,EAAkCC,SAAS,EAA3C,EAA+CC,KAAK,kBAApD,EADT;AAENC,iBAAa,EAAEtJ,MAAM,QAAR,EAAkBmJ,UAAU,IAA5B,EAAkCC,SAAS,EAA3C,EAA+CC,KAAK,wBAApD,EAFP;AAGNE,eAAW,EAAEvJ,MAAM,QAAR,EAAkBmJ,UAAU,IAA5B,EAAkCC,SAAS,EAA3C,EAA+CC,KAAK,sBAApD,EAHL;AAING,iBAAa,EAAExJ,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAAmCC,SAAS,eAAKK,EAAL,EAA5C,EAJP;AAKN9I,aAAS,EAAEX,MAAM,MAAR,EAAgBmJ,UAAU,IAA1B,EAAgCC,SAAS,IAAzC,EALH;AAMNM,eAAW,EAAE1J,MAAM,MAAR,EAAgBmJ,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EANL,EAMwD;AAC9DO,eAAW,EAAE3J,MAAM,MAAR,EAAgBmJ,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EAPL,EAOwD;AAC9DQ,cAAU,EAAE5J,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAAmCC,SAAS,EAA5C,EAAgDC,KAAK,gBAArD,EARJ;AASNQ,cAAU,EAAE7J,MAAM,QAAR,EATJ;AAUN8J,uBAAmB,EAAE9J,MAAM,MAAR,EAAgBmJ,UAAU,KAA1B,EAAiCC,SAAS,IAA1C,EAVb;AAWNW,qBAAiB,EAAE/J,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAAmCC,SAAS,0BAA5C,EAXX;AAYNY,oBAAgB,EAAEhK,MAAM,MAAR,EAAgBmJ,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EAZV;AAaNa,yBAAqB,EAAEjK,MAAM,KAAR,EAAemJ,UAAU,KAAzB,EAAgCC,SAAS,EAAzC,EAA6Cc,YAAY;AAAA,eAAK,iBAAE3G,OAAF,CAAU4G,CAAV,CAAL;AAAA,OAAzD,EAbf;AAcNC,2BAAuB,EAAEpK,MAAM,MAAR,EAAgBmJ,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EAdjB;AAeNiB,6BAAyB,EAAErK,MAAM,MAAR,EAAgBmJ,UAAU,KAA1B,EAAiCC,SAAS,IAA1C,EAfnB;AAgBNkB,oBAAgB,EAAEtK,MAAM,QAAR,EAAkBmJ,UAAU,IAA5B,EAAkCC,SAAS,WAA3C,EAhBV;AAiBNmB,8BAA0B,EAAEvK,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAjBpB;AAkBNqB,+BAA2B,EAAExK,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAlBrB;AAmBNsB,oBAAgB,EAAEzK,MAAM,KAAR,EAAemJ,UAAU,KAAzB,EAAgCC,SAAS,EAAzC,EAA6Cc,YAAY;AAAA,eAAK,iBAAE3G,OAAF,CAAU4G,CAAV,CAAL;AAAA,OAAzD,EAnBV;AAoBNO,2BAAuB,EAAE1K,MAAM,MAAR,EAAgBmJ,UAAU,KAA1B,EAAiCC,SAAS,IAA1C,EApBjB,EAoBmE;AACzEuB,kBAAc,EAAE3K,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAAmCC,SAAS,QAA5C,EArBR,EAqBoE;AAC1EwB,wBAAoB,EAAE5K,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAAmCC,SAAS,kBAA5C,EAtBd;AAuBNyB,sBAAkB,EAAE7K,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAAmCC,SAAS,eAA5C,EAvBZ;AAwBN0B,0BAAsB,EAAE9K,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAAmCC,SAAS,eAA5C,EAxBhB;AAyBN2B,oBAAgB,EAAE/K,MAAM,KAAR,EAAemJ,UAAU,KAAzB,EAAgCC,SAAS,EAAzC,EAA6Cc,YAAY;AAAA,eAAK,iBAAE3G,OAAF,CAAU4G,CAAV,CAAL;AAAA,OAAzD,EAzBV;AA0BNa,0BAAsB,EAAEhL,MAAM,QAAR,EAAkBmJ,UAAU,KAA5B,EAAmCC,SAAS,EAA5C,EA1BhB;AA2BN6B,yBAAqB,EAAEjL,MAAM,MAAR,EAAgBmJ,UAAU,KAA1B,EAAiCC,SAAS,IAA1C,EA3Bf;AA4BN8B,kCAA8B,EAAElL,MAAM,MAAR,EAAgBmJ,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EA5BxB;AA6BN+B,+BAA2B;AACzBnL,YAAM,KADmB;AAEzBmJ,gBAAU,IAFe;AAGzBC,eAAS,CACP,oBADO,EAEP,eAFO,EAGP,UAHO,EAIP,kBAJO,EAKP,qBALO,EAMP,qBANO;AAHgB;AA7BrB,GAFO;;AA6CfgC,QAAM,cAASxF,EAAT,EAAa;;AAEjB,0CAAaA,EAAb,EAAiByF,SAAjB;;AAEAzF,OAAG0F,WAAH,CAAeC,QAAf,CAAwB;AACtB3C,YAAM,wBADgB;AAEtB5I,YAAM,UAFgB;AAGtBwL,aAAO,GAHe;AAItBC,eAASrE,kBAJa;AAKtBzF,cAAQ,oBALc;AAMtB+J,mBAAa,0DACb;AAPsB,KAAxB;;AAUA9F,OAAGpG,SAAH,GAAe,EAAf;AACA,qBAAEmM,KAAF,oBAAiB,UAACC,MAAD,EAAShD,IAAT,EAAkB;;AAEjC,UAAMiD,UAAU,SAAVA,OAAU;AAAA,eAAM,YAAW;AAC/B,cAAIC,MAAMF,OAAOhE,KAAP,CAAa,IAAb,EAAmBmE,SAAnB,CAAV;AACA,cAAM9M,UAAU6M,IAAInJ,QAApB;AACA,iBAAOqJ,MAAMA,GAAGF,GAAH,EAAQ7M,OAAR,CAAb;AACD,SAJe;AAAA,OAAhB;;AAMA,UAAMgN,YAAY,SAAZA,SAAY;AAAA,eAAM,YAAW;AACjC,iBAAQrG,GAAGsG,GAAH,IAAUtG,GAAGsG,GAAH,CAAOD,SAAP,CAAiB;AACjCtK,oBAAQ,oBADyB;AAEjC/B,qBAAS,oHAFwB;AAGjCuM,0BAAc;AAHmB,WAAjB,EAIfH,EAJe,CAAX,IAIIA,GAAGpE,KAAH,CAAS,IAAT,EAAemE,SAAf,CAJX;AAKD,SANiB;AAAA,OAAlB;;AAQA,UAAIK,WAAWxD,KAAKyD,OAAL,CAAa,SAAb,EAAwB,MAAxB,CAAf;AACAzG,SAAGpG,SAAH,CAAa4M,QAAb,IAAyBH,UAAU,mBAAQtE,MAAR,CAAekE,QAAQ,UAACC,GAAD,EAAM7M,OAAN;AAAA,eAAkB2G,GAAG0F,WAAH,CAAegB,YAAf,CAA4BR,GAA5B,KAAoC7M,OAAtD;AAAA,OAAR,CAAf,CAAV,CAAzB;AACA2G,SAAGpG,SAAH,CAAaoJ,IAAb,IAAqBqD,UAAUJ,QAAQ;AAAA,eAAOC,GAAP;AAAA,OAAR,CAAV,CAArB;AACD,KAnBD;;AAqBAnD,qBAAiB/C,EAAjB;AACA,uBAAIA,EAAJ,EArCiB,CAqCT;AACT,GAnFc;;AAqFf2G,SAAO,eAAS3G,EAAT,EAAaoC,MAAb,EAAqB;AAC1BH,wBAAoBjC,EAApB,EAAwBoC,MAAxB,EACC9I,IADD,CACM,YAAM;AACV,8BAAS0G,EAAT,EAAapG,SAAb;;AAEAoG,SAAGpG,SAAH,CAAagN,SAAb,GAAyBhN,SAAzB;;AAEA,UAAMiN,SAAS7G,GAAG8G,SAAH,CAAa,oBAAb,CAAf;;AAEAD,aAAO3G,GAAP,CAAW,SAAX,EAAsB,UAAC6G,GAAD,EAAMxN,GAAN,EAAc;AAClCA,YAAImJ,IAAJ,CAAS9I,UAAUoN,SAAV,EAAT;AACD,OAFD;;AAIAH,aAAOI,IAAP,CAAY,SAAZ,EAAuB,UAACF,GAAD,EAAMxN,GAAN,EAAc;AACnCK,kBAAUsN,SAAV,CAAoBH,IAAII,IAAxB;AACA/E,eAAOgF,OAAP,CAAexN,UAAUoN,SAAV,EAAf,EACC1N,IADD,CACM;AAAA,iBAAMM,UAAUiJ,cAAV,EAAN;AAAA,SADN,EAECvJ,IAFD,CAEM;AAAA,iBAAMC,IAAI8N,UAAJ,CAAe,GAAf,CAAN;AAAA,SAFN,EAGC7N,KAHD,CAGO,UAACC,GAAD,EAAS;AACdF,cAAI+N,MAAJ,CAAW,GAAX,EAAgB5E,IAAhB,CAAqB,EAAE1I,SAASP,IAAIO,OAAf,EAArB;AACD,SALD;AAMD,OARD;;AAUA6M,aAAOI,IAAP,CAAY,aAAZ,EAA2B,UAACF,GAAD,EAAMxN,GAAN,EAAc;AACvC,YAAIK,UAAUoN,SAAV,GAAsBjD,SAA1B,EAAqC;AACnCnK,oBAAU2N,UAAV,GACCjO,IADD,CACM;AAAA,mBAAMC,IAAI8N,UAAJ,CAAe,GAAf,CAAN;AAAA,WADN,EAEC7N,KAFD,CAEO,UAACC,GAAD;AAAA,mBAASF,IAAI+N,MAAJ,CAAW,GAAX,EAAgB5E,IAAhB,CAAqB,EAAE1I,SAASP,IAAIO,OAAf,EAArB,CAAT;AAAA,WAFP;AAGD,SAJD,MAIO;AACLJ,oBAAUgJ,OAAV,GACCtJ,IADD,CACM;AAAA,mBAAMC,IAAI8N,UAAJ,CAAe,GAAf,CAAN;AAAA,WADN,EAEC7N,KAFD,CAEO,UAACC,GAAD;AAAA,mBAASF,IAAI+N,MAAJ,CAAW,GAAX,EAAgB5E,IAAhB,CAAqB,EAAE1I,SAASP,IAAIO,OAAf,EAArB,CAAT;AAAA,WAFP;AAGD;AACF,OAVD;;AAYA6M,aAAOI,IAAP,CAAY,aAAZ,EAA2B,UAACF,GAAD,EAAMxN,GAAN,EAAc;AACvCK,kBAAU4N,qBAAV,GACClO,IADD,CACM,UAACmO,IAAD,EAAU;AACdlO,cAAImJ,IAAJ,CAAS+E,IAAT;AACD,SAHD,EAICjO,KAJD,CAIO,UAACC,GAAD,EAAS;AACdF,cAAI+N,MAAJ,CAAW,GAAX,EAAgB5E,IAAhB,CAAqB,EAAE1I,SAASP,IAAIO,OAAf,EAArB;AACD,SAND;AAOD,OARD;;AAUA6M,aAAO3G,GAAP,CAAW,WAAX,EAAwB,UAAC6G,GAAD,EAAMxN,GAAN,EAAc;AACpC,YAAMmO,cAAcC,KAAKC,KAAL,CAAW,aAAGC,YAAH,CAAgB,eAAK3E,IAAL,CAAUuC,SAAV,EAAqB,iBAArB,CAAhB,CAAX,CAApB;AACAlM,YAAImJ,IAAJ,CAAS,EAAEuB,UAAUyD,YAAYzD,QAAxB,EAAT;AACD,OAHD;;AAKA4C,aAAO3G,GAAP,CAAW,QAAX,EAAqB,UAAC6G,GAAD,EAAMxN,GAAN,EAAa;AAChCsH,cAAME,WAAN,GACCzH,IADD,CACM,UAACwO,MAAD,EAAY;AAChBvO,cAAImJ,IAAJ,CAASoF,MAAT;AACD,SAHD,EAICtO,KAJD,CAIO,UAACC,GAAD;AAAA,iBAASF,IAAI+N,MAAJ,CAAW5E,IAAX,CAAgB,GAAhB,EAAqBA,IAArB,CAA0B,EAAE1I,SAAQP,IAAIO,OAAd,EAA1B,CAAT;AAAA,SAJP;AAKD,OAND;;AAQA6M,aAAOI,IAAP,CAAY,wBAAZ,EAAsC,UAACF,GAAD,EAAMxN,GAAN,EAAc;AAClDK,kBAAUmO,mBAAV,CAA8BhB,IAAII,IAAJ,CAASa,cAAvC,EACG1O,IADH,CACQ,UAACmO,IAAD,EAAS;AACblO,cAAImJ,IAAJ,CAAS+E,IAAT;AACD,SAHH,EAIGjO,KAJH,CAIS,UAACC,GAAD,EAAS;AACdF,cAAI+N,MAAJ,CAAW,GAAX,EAAgB5E,IAAhB,CAAqB,EAAE1I,SAASP,IAAIO,OAAf,EAArB;AACD,SANH;AAOD,OARD;;AAUA6M,aAAO3G,GAAP,CAAW,gBAAX,EAA6B,UAAC6G,GAAD,EAAMxN,GAAN,EAAc;AACzCK,kBAAUqO,QAAV,GACG3O,IADH,CACQ,UAACmO,IAAD,EAAU;AACdlO,cAAImJ,IAAJ,CAAS+E,IAAT;AACD,SAHH,EAIGjO,KAJH,CAIS,UAACC,GAAD,EAAS;AACdF,cAAI+N,MAAJ,CAAW,GAAX,EAAgB5E,IAAhB,CAAqB,EAAE1I,SAASP,IAAIO,OAAf,EAArB;AACD,SANH;AAOD,OARD;AAUD,KA7ED;AA+ED;AArKc,CAAjB,C;;;;;;AC/GA,qD;;;;;;ACAA,iC;;;;;;ACAA,+B;;;;;;ACAA,iC;;;;;;;;;;;;;ACeA;;;;;;;;;;;;;;AAfA;;;;;;;;AAQA,IAAMkO,UAAU,mBAAAnI,CAAQ,CAAR,CAAhB;AACA,IAAMoI,eAAe,mBAAApI,CAAQ,EAAR,CAArB;AACA,IAAMqI,SAAS,mBAAArI,CAAQ,EAAR,CAAf;AACA,IAAMsI,QAAQ,mBAAAtI,CAAQ,EAAR,CAAd;AACA,IAAMD,IAAI,mBAAAC,CAAQ,CAAR,CAAV;AACA,IAAMuI,aAAa,mBAAAvI,CAAQ,EAAR,CAAnB;;AAIAsI,MAAMhP,OAAN,GAAgB6O,OAAhB;;AAEA,IAAMK,kBAAkB,SAAlBA,eAAkB,CAASC,GAAT,EAAc;AACpC,SAAOA,IAAI/B,OAAJ,CAAY,gBAAZ,EAA8B,EAA9B,EAAkCgC,WAAlC,EAAP;AACD,CAFD;;AAIA,IAAIxI,KAAK,IAAT;;IAEMyI,S;;;AACJ,qBAAY1I,EAAZ,EAAgBoC,MAAhB,EAAwB;AAAA;;AAAA;;AAEtB,QAAI,CAACpC,EAAD,IAAO,CAACoC,MAAZ,EAAoB;AAClB,YAAM,IAAI7E,KAAJ,CAAU,yCAAV,CAAN;AACD;;AAED,UAAK2J,SAAL,CAAe9E,MAAf;AACA,UAAKpC,EAAL,GAAUA,EAAV;;AAEAA,OAAGC,EAAH,CAAMC,GAAN,GACC5G,IADD,CACM,aAAK;AACT2G,WAAK,kBAAG0I,CAAH,CAAL;AACA1I,SAAG2I,UAAH;AACD,KAJD;;AAMA,UAAKC,GAAL,GAAW7I,GAAG8G,SAAH,CAAa,oBAAb,EAAmC;AAC5C,yBAAmB,KADyB;AAE5C,cAAQ;AAAA,eAAO,CAAC,aAAaxJ,IAAb,CAAkByJ,IAAI+B,WAAtB,CAAR;AAAA;AAFoC,KAAnC,CAAX;;AAKA,UAAKD,GAAL,CAASE,GAAT,CAAaT,WAAWb,IAAX,CAAgB;AAC3BuB,cAAQ,MAAKC,uBAAL,CAA6BC,IAA7B;AADmB,KAAhB,CAAb;;AAIA,UAAKC,YAAL;AAxBsB;AAyBvB;;;;8BAES/G,M,EAAQ;AAChB,WAAKA,MAAL,GAAcvF,OAAOC,MAAP,CAAc,EAAd,EAAkB,KAAKsF,MAAvB,EAA+BA,MAA/B,CAAd;AACD;;;gCAEW;AACV,aAAO,KAAKA,MAAZ;AACD;;;sCAEiB;AAChB,UAAMgH,SAAS,EAAf;AACA,UAAM7F,WAAW,CAAC,eAAD,EAAkB,aAAlB,EAAiC,WAAjC,EAA8C,UAA9C,EAA0D,aAA1D,CAAjB;;AAEAzD,QAAElC,OAAF,CAAU,KAAKwE,MAAf,EAAuB,UAACiH,KAAD,EAAQC,GAAR,EAAgB;AACrC,YAAIxJ,EAAE1B,QAAF,CAAWmF,QAAX,EAAqB+F,GAArB,MAA8BxJ,EAAEyJ,KAAF,CAAQF,KAAR,KAAkBvJ,EAAE0J,OAAF,CAAUH,KAAV,CAAhD,CAAJ,EAAuE;AACrED,iBAAOK,IAAP,CAAY;AACVH,iBAAKA,GADK;AAEVtP,uDAAyCsP,GAAzC;AAFU,WAAZ;AAID;AACF,OAPD;;AASA,aAAOF,MAAP;AACD;;;8BAES;AAAA;;AACR,aAAO,KAAKM,gBAAL,GACNpQ,IADM,CACD;AAAA,eAAM,OAAKqQ,cAAL,EAAN;AAAA,OADC,CAAP;AAED;;;iCAEY;AACX,aAAO,KAAKC,gBAAL,EAAP;AACD;;;oCAEeC,W,EAAapO,I,EAAMqO,Y,EAAcjL,O,EAAS;AACxD,UAAM7E,UAAU,EAAEyB,UAAF,EAAhB;AACA,UAAMsO,wBAAwB,KAAKC,mBAAL,CAAyBF,YAAzB,CAA9B;AACA,UAAIC,yBAAyBA,sBAAsBtM,MAAtB,GAA+B,CAA5D,EAA+D;AAC7DzD,gBAAQC,aAAR,GAAwB8P,qBAAxB;AACD;AACD,aAAO,KAAKE,WAAL,CAAiBJ,WAAjB,EAA8B7P,OAA9B,EAAuC6E,OAAvC,CAAP;AACD;;;uCAEkBgL,W,EAAapO,I,EAAMyO,O,EAASrL,O,EAAS;AACtD,UAAMrE,UAAU;AACdiE,uBAAe,QADD;AAEdhD;AAFc,OAAhB;AAIA,UAAM0O,mBAAmB,KAAKC,cAAL,CAAoBF,OAApB,CAAzB;AACA1P,cAAQ0P,OAAR,GAAkBC,gBAAlB;AACA,aAAO,KAAK5P,YAAL,CAAkBsP,WAAlB,EAA+BrP,OAA/B,EAAwCqE,OAAxC,CAAP;AACD;;;wCAEmBgL,W,EAAatO,Q,EAAUsD,O,EAAS;AAClD,UAAMrE,UAAU;AACdiE,uBAAe,SADD;AAEdlD;AAFc,OAAhB;AAIA,aAAO,KAAKhB,YAAL,CAAkBsP,WAAlB,EAA+BrP,OAA/B,EAAwCqE,OAAxC,CAAP;AACD;;;iCAEYgL,W,EAAarP,O,EAASqE,O,EAAS;AAC1C,UAAM7E,UAAU;AACdqQ,oBAAY;AACVjQ,gBAAM,UADI;AAEVI;AAFU;AADE,OAAhB;AAMA,aAAO,KAAKyP,WAAL,CAAiBJ,WAAjB,EAA8B7P,OAA9B,EAAuC6E,OAAvC,CAAP;AACD;;;;4EAEoBgL,W,EAAazP,I,EAAMC,G,EAAKyP,Y,EAAcjL,O;;;;;;AACnD7E,uB,GAAU;AACdqQ,8BAAY;AACVjQ,0BAAMA,IADI;AAEVI,6BAAS;AAFC;AADE,iB;;;AAOhB,oBAAIqE,QAAQO,UAAR,IAAsBU,EAAE7B,SAAF,CAAYY,QAAQO,UAApB,CAA1B,EAA2D;AACzDpF,0BAAQqQ,UAAR,CAAmB7P,OAAnB,CAA2B8P,WAA3B,GAAyCzL,QAAQO,UAAjD;AACD;;qBAEGP,QAAQM,Y;;;;;AACVnF,wBAAQqQ,UAAR,CAAmB7P,OAAnB,GAA6B;AAC3B+P,iCAAe1L,QAAQM;AADI,iBAA7B;;;;;8BAGSN,QAAQO,U;;;;;;;;uBAAoBa,GAAGuK,aAAH,CAAiBnQ,GAAjB,C;;;;;;;;;;;;uBACV4F,GAAGwK,aAAH,CAAiBpQ,GAAjB,C;;;AAArB8E,4B;;;AAENnF,wBAAQqQ,UAAR,CAAmB7P,OAAnB,GAA6B;AAC3B+P,iCAAepL;AADY,iBAA7B;;;;;AAIAnF,wBAAQqQ,UAAR,CAAmB7P,OAAnB,CAA2BH,GAA3B,GAAiCA,GAAjC;;;AAGI0P,qC,GAAwB,KAAKC,mBAAL,CAAyBF,YAAzB,C;;AAC9B,oBAAIC,yBAAyBA,sBAAsBtM,MAAtB,GAA+B,CAA5D,EAA+D;AAC7DzD,0BAAQC,aAAR,GAAwB8P,qBAAxB;AACD;;iDAEM,KAAKE,WAAL,CAAiBJ,WAAjB,EAA8B7P,OAA9B,EAAuC6E,OAAvC,EACNvF,IADM,CACD,eAAO;AACX,sBAAIC,OAAOA,IAAIgR,aAAf,EAA8B;AAC5BtK,uBAAGyK,aAAH,CAAiBrQ,GAAjB,EAAsBd,IAAIgR,aAA1B;AACD;AACF,iBALM,C;;;;;;;;;;;;;;;;;;+BAQEV,W,EAAa7D,M,EAAQ;AAC9B,aAAO,KAAK2E,WAAL,CAAiB;AACtBC,mBAAW;AACTpK,cAAIqJ;AADK,SADW;AAItBgB,uBAAe7E;AAJO,OAAjB,CAAP;AAMD;;;gCAEW6D,W,EAAa7P,O,EAAS6E,O,EAAS;AAAA;;AACzC,UAAMkI,MAAM,SAANA,GAAM;AAAA,eAAM,OAAK4D,WAAL,CAAiB;AACjCC,qBAAW;AACTpK,gBAAIqJ;AADK,WADsB;AAIjC7P;AAJiC,SAAjB,CAAN;AAAA,OAAZ;;AAOA,UAAI6E,WAAWA,QAAQlE,MAAvB,EAA+B;AAC7B,YAAMmQ,cAAe9Q,WAAWA,QAAQyB,IAApB,GAA4B,MAAMzB,QAAQyB,IAAR,CAAagC,MAAb,GAAsB,EAAxD,GAA6D,IAAjF;AACA,YAAMsN,UAAW,OAAOlM,QAAQlE,MAAf,KAA0B,QAA3B,GAAuCkE,QAAQlE,MAA/C,GAAwDmQ,WAAxE;AACA,eAAO,KAAKpQ,mBAAL,CAAyBmP,WAAzB,EAAsCkB,OAAtC,EAA+CzR,IAA/C,CAAoDyN,GAApD,CAAP;AACD;;AAED,aAAOA,KAAP;AACD;;;4CAEuB;AACtB,UAAMzD,gBAAgB,KAAKlB,MAAL,CAAYkB,aAAlC;AACA,UAAMI,cAAc,KAAKtB,MAAL,CAAYsB,WAAhC;;AAEA,aAAO2E,2CAAyC/E,aAAzC,4BAA+E;AACpFvB,gBAAQ,MAD4E;AAEpFiJ,iBAAS,EAAC,gBAAgB,kBAAjB,EAF2E;AAGpF7D,cAAMQ,KAAKsD,SAAL,CAAe;AACnBC,qBAAW5H,aADQ;AAEnB6H,kBAAQ,MAFW;AAGnBC,iBAAO,UAHY;AAInBC,yBAAe,EAAEC,SAAShI,aAAX,EAJI;AAKnBiI,wBAAc7H;AALK,SAAf;AAH8E,OAA/E,EAWNpK,IAXM,CAWD,KAAKkS,uBAXJ,EAYNlS,IAZM,CAYD;AAAA,eAAOC,IAAIkO,IAAJ,EAAP;AAAA,OAZC,CAAP;AAaD;;;gCAEWN,I,EAAMsE,Q,EAAU1J,M,EAAQ;AAAA;;AAClC0J,iBAAWA,YAAY,UAAvB;AACA1J,eAASA,UAAU,MAAnB;;AAEA,UAAM1H,8CAA4CoR,QAAlD;AACA,aAAOpD,MAAShO,GAAT,sBAA6B,KAAK+H,MAAL,CAAYsB,WAAzC,EAAwD;AAC7D3B,sBAD6D;AAE7DiJ,iBAAS,EAAE,gBAAgB,kBAAlB,EAFoD;AAG7D7D,cAAMQ,KAAKsD,SAAL,CAAe9D,IAAf;AAHuD,OAAxD,EAKN7N,IALM,CAKD,KAAKkS,uBALJ,EAMNlS,IANM,CAMD;AAAA,eAAOC,IAAIkO,IAAJ,EAAP;AAAA,OANC,EAONnO,IAPM,CAOD,gBAAQ;AACZ,eAAKoS,YAAL,CAAkB,kBAAlB,EAAsC,EAAErR,QAAF,EAAOsR,OAAO,OAAKvJ,MAAL,CAAYsB,WAA1B,EAAuCyD,UAAvC,EAA6CsE,kBAA7C,EAAuD1J,cAAvD,EAA+D6J,UAAUnE,IAAzE,EAAtC;AACA,eAAOA,IAAP;AACD,OAVM,CAAP;AAWD;;;sCAEiBN,I,EAAMpF,M,EAAQ;AAC9B,aAAO,KAAK4I,WAAL,CAAiBxD,IAAjB,EAAuB,iBAAvB,EAA0CpF,MAA1C,CAAP;AACD;;;wCAEmB8H,W,EAAagC,Y,EAAc;AAAA;;AAC7C,UAAId,UAAU,CAACc,YAAD,IAAiBC,MAAMD,YAAN,CAAjB,GAAuC,CAAvC,GAA2CA,YAAzD;AACAd,gBAAUrO,KAAKqP,GAAL,CAAS,KAAT,EAAgBhB,OAAhB,CAAV;;AAEA,UAAIc,iBAAiB,IAArB,EAA2B;AACzBd,kBAAU,IAAV;AACD;;AAED,UAAMiB,SAASjB,UAAU,CAAV,GACX7C,QAAQ/L,OAAR,CAAgB,KAAKtB,UAAL,CAAgBgP,WAAhB,EAA6B,WAA7B,CAAhB,CADW,GAEX3B,QAAQ/L,OAAR,CAAgB,IAAhB,CAFJ;;AAIA,aAAO6P,OACNC,KADM,CACAlB,UAAU,IADV,EAENzR,IAFM,CAED;AAAA,eAAM,OAAKuB,UAAL,CAAgBgP,WAAhB,EAA6B,YAA7B,CAAN;AAAA,OAFC,CAAP;AAGD;;;mCAEcxM,M,EAAQ;AACrB,UAAMhD,2CAAyCgD,MAAzC,qFAA+H,KAAK+E,MAAL,CAAYsB,WAAjJ;AACA,aAAO2E,MAAMhO,GAAN,EACJf,IADI,CACC,KAAKkS,uBADN,EAEJlS,IAFI,CAEC;AAAA,eAAOC,IAAIkO,IAAJ,EAAP;AAAA,OAFD,EAGJjO,KAHI,CAGE;AAAA,eAAO0S,QAAQC,GAAR,kCAA2C1S,GAA3C,CAAP;AAAA,OAHF,CAAP;AAID;;;kDAE6B;AAC5B,UAAI2S,UAAU,EAAEC,iBAAiB,EAAnB,EAAd;;AAEA,cAAO,KAAKjK,MAAL,CAAYsC,cAAnB;AACE,aAAK,WAAL;AACE0H,kBAAQC,eAAR,CAAwBC,aAAxB,GAAwC,KAAxC;AACA;AACF,aAAK,YAAL;AACE,cAAIC,qBAAqB,KAAKnK,MAAL,CAAYuC,wBAAZ,CAAqC6H,KAArC,CAA2C,OAA3C,CAAzB;AACAJ,kBAAQC,eAAR,CAAwBC,aAAxB,GAAwC,QAAxC;AACAF,kBAAQC,eAAR,CAAwBI,SAAxB,GAAoC;AAClCC,uBAAWH;AADuB,WAApC;AAGA;AACF,aAAK,aAAL;AACEH,kBAAQC,eAAR,CAAwBC,aAAxB,GAAwC,QAAxC;AACA,cAAIK,qBAAqB,KAAKvK,MAAL,CAAYwC,yBAAZ,CAAsC4H,KAAtC,CAA4C,OAA5C,CAAzB;AACAJ,kBAAQC,eAAR,CAAwBI,SAAxB,GAAoC;AAClCG,uBAAWD;AADuB,WAApC;AAGA;AACF,aAAK,YAAL;AACEP,kBAAQC,eAAR,CAAwBC,aAAxB,GAAwC,MAAxC;AACA;AApBJ;;AAuBA,aAAOF,OAAP;AACD;;;wCAEmB;AAClB,UAAM/R,6EAA2E,KAAK+H,MAAL,CAAYsB,WAA7F;AACA,UAAI0I,UAAU,KAAKS,2BAAL,EAAd;;AAEA,aAAO,KAAKlC,WAAL,CAAiByB,OAAjB,EAA0B,mBAA1B,EAA+C,MAA/C,CAAP;AACD;;;;8EAE2BtQ,O,EAASsJ,oB;;;;;;AACnC;AACA;AACA;AACA;AACA;AACA;AACA,oBAAG,CAACtF,EAAE0J,OAAF,CAAUpE,oBAAV,CAAJ,EAAqC;AACnC,sBAAGtJ,QAAQgR,OAAR,CAAgB1H,oBAAhB,KAAyC,CAAC,CAA7C,EAAgD;AAC9CtJ,4BAAQ2N,IAAR,CAAarE,oBAAb;AACD;AACF;;AAEK/K,mB,0EAA2E,KAAK+H,MAAL,CAAYsB,W;;uBAEvF2E,MAAMhO,GAAN,EAAW;AACf0H,0BAAQ,QADO;AAEfiJ,2BAAS,EAAE,gBAAgB,kBAAlB,EAFM;AAGf7D,wBAAMQ,KAAKsD,SAAL,CAAe;AACnB8B,4BAAQ,CACN,qBADM;AADW,mBAAf;AAHS,iBAAX,EASLzT,IATK,CASA,KAAKkS,uBATL,C;;;sBAWF1P,QAAQ2B,MAAR,KAAmB,C;;;;;;;;kDAIhB4K,MAAMhO,GAAN,EAAW;AAChB0H,0BAAQ,MADQ;AAEhBiJ,2BAAS,EAAE,gBAAgB,kBAAlB,EAFO;AAGhB7D,wBAAMQ,KAAKsD,SAAL,CAAe;AACnB+B,yCAAqBlR;AADF,mBAAf;AAHU,iBAAX,EAONxC,IAPM,CAOD,KAAKkS,uBAPJ,C;;;;;;;;;;;;;;;;;;oCAUO/P,I,EAAM;AACpB,aAAO,KAAKwR,iBAAL,CAAuB;AAC5BC,sBAAc,UADc;AAE5BC,kBAAU,EAAE1R,UAAF;AAFkB,OAAvB,CAAP;AAID;;;yCAEoB;AACnB,aAAO,KAAKwR,iBAAL,CAAuB;AAC5BC,sBAAc;AADc,OAAvB,EAEJ,QAFI,CAAP;AAGD;;;wCAEmBlH,M,EAAQ;AAC1B,UAAMxL,UAAW,OAAOwL,MAAP,KAAkB,QAAnB,GAA+BA,MAA/B,GAAwC,aAAxD;AACA,UAAI,OAAOA,MAAP,KAAkB,UAAtB,EAAkC;AAChC,aAAKoH,EAAL,eAAoB5S,OAApB,EAA+BwL,MAA/B;AACD;AACD,aAAO,KAAKiH,iBAAL,CAAuB;AAC5BC,sBAAc,iBADc;AAE5BG,sBAAc,YAFc;AAG5BC,yBAAiB,CAAE,EAAE9S,gBAAF,EAAF;AAHW,OAAvB,CAAP;AAKD;;;6CAEwB;AACvB,aAAO,KAAKyS,iBAAL,CAAuB;AAC5BC,sBAAc,iBADc;AAE5BG,sBAAc;AAFc,OAAvB,EAGJ,QAHI,CAAP;AAID;;;sCAEiBnD,O,EAAS1F,qB,EAAuB;AAChD,UAAM2F,mBAAmB,KAAKC,cAAL,CAAoBF,OAApB,CAAzB;AACA,aAAO,KAAKS,WAAL,CAAiB;AACtB4C,yBAAiB,CACf,EAAE;AACArM,kBAAQ,SADV;AAEEsM,mCAAyBhJ,qBAF3B;AAGE8I,2BAAiBpD;AAHnB,SADe;AADK,OAAjB,EAQJ,mBARI,CAAP;AASD;;;2CAEsB;AACrB,aAAO,KAAKS,WAAL,CAAiB;AACtB,kBAAS,CAAE,iBAAF;AADa,OAAjB,EAEJ,mBAFI,EAEiB,QAFjB,CAAP;AAGD;;AAED;;;;;;;;;sDAMkC8C,Q,EAAUC,O,EAASC,U,EAAY;AAC/D,UAAIC,cAAc,MAAlB;AACA,UAAID,cAAc,IAAlB,EAAuB;AACrBC,sBAAc,MAAd;AACD;;AAED,aAAO;AACL,oBAAa;AACX,iBAAOH,QADI;AAEX,kCAAwB,MAFb;AAGX,qBAAUC,OAHC;AAIX,kCAAwBE;AAJb;AADR,OAAP;AAQD;;;wDAEmC;AAClC,aAAO;AACL,kBAAU,CACR,UADQ;AADL,OAAP;AAKD;;;iDAE4B;AAC3B,UAAMvT,6EAA2E,KAAK+H,MAAL,CAAYsB,WAA7F;AACA,UAAI0I,UAAU,KAAKyB,iCAAL,EAAd;;AAEA,aAAO,KAAKlD,WAAL,CAAiByB,OAAjB,EAA0B,mBAA1B,EAA+C,QAA/C,CAAP;AACD;;;4CAEuBqB,Q,EAAUC,O,EAASC,U,EAAY;AACrD,UAAMtT,6EAA2E,KAAK+H,MAAL,CAAYsB,WAA7F;;AAEA,UAAI0I,UAAU,KAAK0B,iCAAL,CAAuCL,QAAvC,EAAiDC,OAAjD,EAA0DC,UAA1D,CAAd;;AAEA,aAAO,KAAKhD,WAAL,CAAiByB,OAAjB,EAA0B,mBAA1B,EAA+C,MAA/C,CAAP;AACD;;AAED;AACA;;;;+CAC2B2B,M,EAAQ;AACjC,aAAO;AACL,wBAAgB,SADX;AAEL,mCAA2B,QAFtB;AAGL,2BAAmB,CAACA,MAAD;AAHd,OAAP;AAKD;;;iDAC4B;AAC3B,aAAO;AACL,wBAAgB,SADX;AAEL,mCAA2B,KAFtB;AAGL,2BAAmB,KAAK3L,MAAL,CAAY+C;AAH1B,OAAP;AAKD;;;wCAEmB;AAClB,UAAG,KAAK/C,MAAL,CAAY+C,cAAZ,CAA2B1H,MAA3B,IAAqC,CAAxC,EAA2C;AACzC;AACD;AACD,UAAM2O,UAAU,KAAK4B,0BAAL,EAAhB;AACA,aAAO,KAAKf,iBAAL,CAAuBb,OAAvB,EAAgC,MAAhC,CAAP;AAED;;;wCACmB2B,M,EAAQ;AAC1B,UAAM3B,UAAU,KAAK6B,0BAAL,CAAgCF,MAAhC,CAAhB;AACA,aAAO,KAAKd,iBAAL,CAAuBb,OAAvB,EAAgC,MAAhC,CAAP;AACD;;;qCAEe;AACd,aAAO,KAAKnE,QAAL,EAAP;AACD;;;qCAEgB;AAAA;;AACf,UAAMiG,mBAAmB,SAAnBA,gBAAmB;AAAA,eAAM,OAAK9L,MAAL,CAAY8B,iBAAZ,GAC3B,OAAKlJ,mBAAL,EAD2B,GAE3B,OAAKE,sBAAL,EAFqB;AAAA,OAAzB;;AAIA,UAAMiT,qBAAqB,SAArBA,kBAAqB;AAAA,eAAMrO,EAAE0J,OAAF,CAAU,OAAKpH,MAAL,CAAY+B,eAAtB,IAC7B,OAAKxI,kBAAL,EAD6B,GAE7B,OAAKD,eAAL,CAAqB,OAAK0G,MAAL,CAAY+B,eAAjC,CAFuB;AAAA,OAA3B;;AAIA,UAAMiK,QAAQ,KAAKC,4BAAL,CAAkC,KAAKjM,MAAL,CAAYiC,mBAA9C,CAAd;AACA,UAAMiK,uBAAuB,SAAvBA,oBAAuB;AAAA,eAAM,OAAKlM,MAAL,CAAYgC,cAAZ,GAC/B,OAAK9I,iBAAL,CAAuB8S,KAAvB,EAA8B,OAAKhM,MAAL,CAAYoC,qBAA1C,CAD+B,GAE/B,OAAKnJ,oBAAL,EAFyB;AAAA,OAA7B;;AAIA,UAAMkT,uBAAuB,SAAvBA,oBAAuB;AAAA,eAAM,OAAKC,iBAAL,EAAN;AAAA,OAA7B;;AAEA,UAAMC,uBAAuB,SAAvBA,oBAAuB;AAAA,eAAM,OAAK5S,qBAAL,CAA2B,OAAKuG,MAAL,CAAYyC,cAAvC,EAAuD,OAAKzC,MAAL,CAAYgD,oBAAnE,CAAN;AAAA,OAA7B;;AAEA,UAAMsJ,6BAA6B,SAA7BA,0BAA6B;AAAA,eAAM5O,EAAE0J,OAAF,CAAU,OAAKpH,MAAL,CAAYgD,oBAAtB,IAA8C,OAAKuJ,0BAAL,EAA9C,GAAkF,OAAKC,uBAAL,CAA6B,OAAKxM,MAAL,CAAYgD,oBAAzC,EAA+D,OAAKhD,MAAL,CAAYiD,mBAA3E,EAAgG,OAAKjD,MAAL,CAAYkD,4BAA5G,CAAxF;AAAA,OAAnC;;AAEA,UAAMuJ,uBAAuB,SAAvBA,oBAAuB;AAAA,eAAM,OAAKC,iBAAL,EAAN;AAAA,OAA7B;;AAEA,UAAIC,SAAS,KAAb;AACA,UAAMC,kBAAkB,SAAlBA,eAAkB,CAACC,OAAD;AAAA,eAAa,UAACxV,GAAD,EAAS;AAC5C,cAAIsV,MAAJ,EAAY,MAAMtV,GAAN;AACZ,cAAMO,6BAA2BiV,OAA3B,UAAuCxV,IAAIO,OAAjD;AACA+U,mBAAS,IAAT;AACA,gBAAM,IAAIxR,KAAJ,CAAUvD,OAAV,CAAN;AACD,SALuB;AAAA,OAAxB;;AAOA,aAAOkU,mBACN1U,KADM,CACAwV,gBAAgB,aAAhB,CADA,EAEN1V,IAFM,CAED6U,kBAFC,EAGN3U,KAHM,CAGAwV,gBAAgB,eAAhB,CAHA,EAIN1V,IAJM,CAIDgV,oBAJC,EAKN9U,KALM,CAKAwV,gBAAgB,iBAAhB,CALA,EAMN1V,IANM,CAMDiV,oBANC,EAON/U,KAPM,CAOAwV,gBAAgB,iBAAhB,CAPA,EAQN1V,IARM,CAQDmV,oBARC,EASNjV,KATM,CASAwV,gBAAgB,iBAAhB,CATA,EAUN1V,IAVM,CAUDoV,0BAVC,EAWNlV,KAXM,CAWAwV,gBAAgB,iBAAhB,CAXA,EAYN1V,IAZM,CAYDuV,oBAZC,EAaNrV,KAbM,CAaAwV,gBAAgB,iBAAhB,CAbA,CAAP;AAeD;;;2BAEME,O,EAAS;AACd,aAAOA,QAAQlN,KAAR,CAAc,IAAd,EAAoB,CAAE,IAAF,CAApB,CAAP;AACD;;;mCAEckI,O,EAAS;AACtB,aAAOA,WAAWA,QAAQpJ,GAAR,CAAY,UAACqO,MAAD,EAAY;AACxC,YAAI,OAAOA,MAAP,KAAkB,QAAtB,EAAgC;AAC9B,iBAAO;AACL/U,kBAAM,UADD;AAEL2D,mBAAOoR,MAFF;AAGL3U,qBAAS,YAAY+N,gBAAgB4G,MAAhB;AAHhB,WAAP;AAKD,SAND,MAMO,IAAIA,UAAUA,OAAOpR,KAArB,EAA4B;AACjC,iBAAOoR,MAAP;AACD;AACD,eAAO,EAAP;AACD,OAXiB,CAAlB;AAYD;;;wCAEmBrF,Y,EAAc;AAChC,aAAOA,gBAAgBA,aAAahJ,GAAb,CAAiB,UAACsO,KAAD,EAAW;AACjD,YAAI,OAAOA,KAAP,KAAiB,QAArB,EAA+B;AAC7B,iBAAO;AACLC,0BAAc,MADT;AAELtR,mBAAOqR,KAFF;AAGL5U,qBAAS,QAAQ+N,gBAAgB6G,KAAhB;AAHZ,WAAP;AAKD,SAND,MAMO,IAAIA,SAASA,MAAMrR,KAAnB,EAA0B;AAC/B,iBAAO;AACLsR,0BAAcD,MAAMC,YAAN,IAAsB,MAD/B;AAELtR,mBAAOqR,MAAMrR,KAFR;AAGLvD,qBAAS4U,MAAM5U,OAAN,IAAiB,QAAQ+N,gBAAgB6G,MAAMrR,KAAtB,CAH7B;AAILuR,uBAAWF,MAAME;AAJZ,WAAP;AAMD;AACD,eAAOF,KAAP;AACD,OAhBsB,CAAvB;AAiBD;;;iCAEYhV,I,EAAMT,K,EAAO;AACxB,WAAK4V,IAAL,CAAUnV,IAAV,EAAgBT,KAAhB;AACD;;;wCAEmBA,K,EAAO;AACzB,UAAM8B,OAAO9B,MAAMK,OAAN,CAAcyB,IAA3B;AACA,UAAI,CAACA,IAAL,EAAW;AAAE;AAAQ;;AAErB,WAAKiQ,YAAL,CAAkB,SAAlB,EAA6B/R,KAA7B;;AAEA,UAAIA,MAAMK,OAAN,IAAiB,KAAKoI,MAAL,CAAYqC,uBAAjC,EAA0D;AACxD,aAAK5J,UAAL,CAAgBlB,MAAM6V,MAAN,CAAahP,EAA7B,EAAiC,WAAjC;AACD;AACF;;;2CAEsB7G,K,EAAO;AAC5B,WAAK+R,YAAL,CAAkB,YAAlB,EAAgC/R,KAAhC;;AAEA,UAAIA,MAAMK,OAAN,IAAiB,KAAKoI,MAAL,CAAYqC,uBAAjC,EAA0D;AACxD,aAAK5J,UAAL,CAAgBlB,MAAM6V,MAAN,CAAahP,EAA7B,EAAiC,WAAjC;AACD;AACF;;;yCAEoB7G,K,EAAO;AAC1B,UAAMa,UAAUb,MAAMsB,QAAN,CAAeT,OAA/B;AACA,UAAIA,OAAJ,EAAa;AACX,aAAKkR,YAAL,eAA8BlR,OAA9B,EAAyCb,KAAzC;AACD;AACD,WAAK+R,YAAL,CAAkB,UAAlB,EAA8B/R,KAA9B;AACD;;;2CAEsBA,K,EAAO;AAC5B,UAAMa,UAAUb,MAAMK,OAAN,CAAc8D,WAAd,IAA6BnE,MAAMK,OAAN,CAAc8D,WAAd,CAA0BtD,OAAvE;AACA,UAAIA,OAAJ,EAAa;AACX,aAAKkR,YAAL,kBAAiClR,OAAjC,EAA4Cb,KAA5C;AACD;AACD,WAAK+R,YAAL,CAAkB,aAAlB,EAAiC/R,KAAjC;;AAEA,UAAIA,MAAMK,OAAN,IAAiB,KAAKoI,MAAL,CAAYqC,uBAAjC,EAA0D;AACxD,aAAK5J,UAAL,CAAgBlB,MAAM6V,MAAN,CAAahP,EAA7B,EAAiC,WAAjC;AACD;AACF;;;4CAEuBjH,G,EAAK;AAC3B,UAAI,CAACA,GAAL,EAAU;;AAEV,UAAIA,IAAI+N,MAAJ,GAAa,GAAjB,EAAsB;AACpB,eAAO/N,GAAP;AACD;;AAED,UAAIkW,eAAe,6CAAnB;AACAA,sBAAgB,eAAelW,IAAI+N,MAAnB,GAA4B,IAA5B,GAAmC/N,IAAImW,UAAvC,GAAoD,GAApE;;AAEA,aAAOxH,QAAQ/L,OAAR,CAAgB,IAAhB,EACN7C,IADM,CACD;AAAA,eAAMC,IAAIkO,IAAJ,EAAN;AAAA,OADC,EAENnO,IAFM,CAED,gBAAQ;AACZmW,wBAAgB,OAAOhI,KAAK3E,KAAL,CAAW9I,OAAlC;AACD,OAJM,EAKN2V,OALM,CAKE,YAAM;AACb,cAAM,IAAIpS,KAAJ,CAAUkS,YAAV,CAAN;AACD,OAPM,CAAP;AAQD;;;mCAEc;AAAA;;AACb,WAAK5G,GAAL,CAAS3I,GAAT,CAAa,UAAb,EAAyB,UAAC6G,GAAD,EAAMxN,GAAN,EAAc;AACrC,YAAIwN,IAAI6I,KAAJ,CAAU,UAAV,MAA0B,WAA1B,IAAyC7I,IAAI6I,KAAJ,CAAU,kBAAV,MAAkC,OAAKxN,MAAL,CAAYwB,WAA3F,EAAwG;;AAEtGrK,cAAI+N,MAAJ,CAAW,GAAX,EAAgB5E,IAAhB,CAAqBqE,IAAI6I,KAAJ,CAAU,eAAV,CAArB;AACD,SAHD,MAGO;AACL1D,kBAAQpJ,KAAR,CAAc,2DAAd;AACAvJ,cAAI8N,UAAJ,CAAe,GAAf;AACD;AACF,OARD;;AAUA,WAAKwB,GAAL,CAAS5B,IAAT,CAAc,UAAd,EAA0B,UAACF,GAAD,EAAMxN,GAAN,EAAc;AACtC,YAAIsW,OAAO9I,IAAII,IAAf;AACA,YAAI0I,KAAK1E,MAAL,KAAgB,MAApB,EAA4B;AAC1B;AACD;;AAED,eAAKO,YAAL,CAAkB,kBAAlB,EAAsCmE,IAAtC;;AAEA;AACAA,aAAKC,KAAL,CAAWlS,OAAX,CAAmB,UAACkS,KAAD,EAAW;AAC5B,cAAIA,SAAS,CAACA,MAAMC,SAApB,EAA+B;AAC7B;AACD;AACD;AACAD,gBAAMC,SAAN,CAAgBnS,OAAhB,CAAwB,UAACjE,KAAD,EAAW;AACjC,gBAAIA,MAAMK,OAAN,IAAiBL,MAAMK,OAAN,CAAcgW,OAA/B,IAA0C,CAAC,OAAK5N,MAAL,CAAY6N,eAA3D,EAA4E;AAC1E;AACD;AACD,gBAAItW,MAAMK,OAAN,IAAiBL,MAAMK,OAAN,CAAcyB,IAAnC,EAAyC;AACvC,kBAAI9B,MAAMK,OAAN,CAAc8D,WAAlB,EAA+B;AAC7B,uBAAKoS,sBAAL,CAA4BvW,KAA5B;AACD,eAFD,MAEO;AACL,uBAAKwW,mBAAL,CAAyBxW,KAAzB;AACD;AACF,aAND,MAMO,IAAIA,MAAMK,OAAN,IAAiBL,MAAMK,OAAN,CAAcoW,WAAnC,EAAgD;AACrD,qBAAKC,sBAAL,CAA4B1W,KAA5B;AACD,aAFM,MAEA,IAAIA,MAAMsB,QAAV,EAAoB;AACzB,qBAAKqV,oBAAL,CAA0B3W,KAA1B;AACD,aAFM,MAEA,IAAIA,MAAM4W,QAAV,EAAoB;AACzB,qBAAK7E,YAAL,CAAkB,UAAlB,EAA8B/R,KAA9B;AACD,aAFM,MAEA,IAAIA,MAAM6W,IAAV,EAAgB;AACrB,qBAAK9E,YAAL,CAAkB,MAAlB,EAA0B/R,KAA1B;AACD,aAFM,MAEA,IAAIA,MAAM8W,eAAV,EAA2B;AAChC,qBAAK/E,YAAL,CAAkB,iBAAlB,EAAqC/R,KAArC;AACD,aAFM,MAEA,IAAIA,MAAM+W,KAAV,EAAiB;AACtB,qBAAKhF,YAAL,CAAkB,OAAlB,EAA2B/R,KAA3B;AACD,aAFM,MAEA,IAAIA,MAAMgX,QAAV,EAAoB;AACzB,qBAAKjF,YAAL,CAAkB,UAAlB,EAA8B/R,KAA9B;AACD,aAFM,MAEA,IAAIA,MAAMiX,OAAV,EAAkB;AACvB,qBAAKlF,YAAL,CAAkB,SAAlB,EAA6B/R,KAA7B;AACD,aAFM,MAGF;AACHuS,sBAAQC,GAAR,CAAY,kCAAZ,EAAgDxS,KAAhD;AACD;AACF,WA9BD;AA+BD,SApCD;;AAsCA;AACAJ,YAAI8N,UAAJ,CAAe,GAAf;AACD,OAjDD;AAkDD;;;4CAEuBN,G,EAAKxN,G,EAAKsX,G,EAAK;AACrC,UAAI,CAAC,cAAcvT,IAAd,CAAmByJ,IAAI+J,IAAvB,CAAL,EAAmC;AACjC;AACD;;AAED,UAAIC,YAAYhK,IAAIiE,OAAJ,CAAY,iBAAZ,CAAhB;AACA,UAAI,CAAC+F,SAAL,EAAgB;AACd,cAAM,IAAIxT,KAAJ,CAAU,2CAAV,CAAN;AACD,OAFD,MAEO;AAAA,+BACUwT,UAAUvE,KAAV,CAAgB,GAAhB,CADV;AAAA;AAAA,YACEwE,IADF;;AAEL,YAAIC,eAAe7I,OAAO8I,UAAP,CAAkB,MAAlB,EAA0B,KAAK9O,MAAL,CAAYuB,SAAtC,EAAiDwN,MAAjD,CAAwDN,GAAxD,EAA6DO,MAA7D,CAAoE,KAApE,CAAnB;;AAEA,YAAIJ,QAAQC,YAAZ,EAA0B;AACxB,gBAAM,IAAI1T,KAAJ,CAAU,2CAAV,CAAN;AACD;AACF;AACF;;;mDAE8B;AAC7B,UAAI,KAAK6E,MAAL,CAAYgC,cAAZ,IAA8B,KAAKhC,MAAL,CAAYiC,mBAA9C,EAAmE;AACjE,eAAO,KAAKjC,MAAL,CAAYiC,mBAAZ,CAAgCvD,GAAhC,CAAoC,UAACuQ,IAAD,EAAU;;AAEnD,cAAIA,KAAKhI,KAAL,IAAcgI,KAAKjX,IAAL,KAAc,UAAhC,EAA4C;AAC1CiX,iBAAK7W,OAAL,GAAe6W,KAAKhI,KAApB;AACA,mBAAOgI,KAAKhI,KAAZ;AACD,WAHD,MAGO,IAAIgI,KAAKhI,KAAL,IAAcgI,KAAKjX,IAAL,KAAc,KAAhC,EAAuC;AAC5CiX,iBAAKhX,GAAL,GAAWgX,KAAKhI,KAAhB;AACAgI,iBAAKjX,IAAL,GAAY,SAAZ;AACA,mBAAOiX,KAAKhI,KAAZ;AACD;AACD,iBAAOgI,IAAP;AACD,SAXM,CAAP;AAYD;AACF;;;uCAEkB;AAAA;;AACjB,UAAMC,WAAW,uDACf,aADe,GACC,KAAKlP,MAAL,CAAYkB,aADb,GAEf,iBAFe,GAEK,KAAKlB,MAAL,CAAYuB,SAFjB,GAGf,gCAHF;;AAKA,UAAMtJ,2CAAyC,KAAK+H,MAAL,CAAYkB,aAArD,iCAAN;;AAEA,aAAO+E,MAAMiJ,QAAN,EACNhY,IADM,CACD,KAAKkS,uBADJ,EAENlS,IAFM,CAED;AAAA,eAAOC,IAAIkO,IAAJ,EAAP;AAAA,OAFC,EAGNnO,IAHM,CAGD;AAAA,eAAQmO,KAAK8D,YAAb;AAAA,OAHC,EAINjS,IAJM,CAID;AAAA,eAAS+O,MAAMhO,MAAMsR,KAAZ,EAAmB;AAChC5J,kBAAQ,MADwB;AAEhCiJ,mBAAS,EAAC,gBAAgB,kBAAjB,EAFuB;AAGhC7D,gBAAMQ,KAAKsD,SAAL,CAAe;AACnBE,oBAAQ,MADW;AAEnBoG,0BAAc,aAAa,OAAKnP,MAAL,CAAY4B,QAAzB,GAAoC,iCAF/B;AAGnBwN,0BAAc,OAAKpP,MAAL,CAAYwB,WAHP;AAInBmJ,oBAAQ,OAAK3K,MAAL,CAAYmD;AAJD,WAAf;AAH0B,SAAnB,CAAT;AAAA,OAJC,EAcNjM,IAdM,CAcD,KAAKkS,uBAdJ,EAeNlS,IAfM,CAeD;AAAA,eAAOC,IAAIkO,IAAJ,EAAP;AAAA,OAfC,CAAP;AAgBD;;;qCAEgB;AACf,UAAMpN,MAAM,qEAAqE,KAAK+H,MAAL,CAAYsB,WAA7F;;AAEA,aAAO2E,MAAMhO,GAAN,EAAW,EAAE0H,QAAQ,MAAV,EAAX,EACNzI,IADM,CACD,KAAKkS,uBADJ,EAENlS,IAFM,CAED;AAAA,eAAOC,IAAIkO,IAAJ,EAAP;AAAA,OAFC,EAGNjO,KAHM,CAGA;AAAA,eAAO0S,QAAQC,GAAR,CAAY1S,GAAZ,CAAP;AAAA,OAHA,CAAP;AAID;;;uCAEkB;AACjB,UAAMY,MAAM,qEAAqE,KAAK+H,MAAL,CAAYsB,WAA7F;;AAEA,aAAO2E,MAAMhO,GAAN,EAAW,EAAE0H,QAAQ,QAAV,EAAX,EACNzI,IADM,CACD,KAAKkS,uBADJ,EAENlS,IAFM,CAED;AAAA,eAAOC,IAAIkO,IAAJ,EAAP;AAAA,OAFC,EAGNjO,KAHM,CAGA;AAAA,eAAO0S,QAAQC,GAAR,CAAY1S,GAAZ,CAAP;AAAA,OAHA,CAAP;AAID;;;+BAEU;AACT,UAAMY,MAAM,sDAAsD,KAAK+H,MAAL,CAAYsB,WAA9E;;AAEA,aAAO2E,MAAMhO,GAAN,EAAW,EAAE0H,QAAQ,KAAV,EAAX,EACNzI,IADM,CACD,KAAKkS,uBADJ,EAENlS,IAFM,CAED;AAAA,eAAOC,IAAIkO,IAAJ,EAAP;AAAA,OAFC,EAGNjO,KAHM,CAGA;AAAA,eAAO0S,QAAQC,GAAR,CAAY1S,GAAZ,CAAP;AAAA,OAHA,CAAP;AAID;;;;EA7tBqB0O,Y;;AAiuBxBpM,OAAOC,OAAP,GAAiB0M,SAAjB,C;;;;;;;;;AC1vBA;;AAEA,IAAIvI,OAAO,IAAX;;AAEA,SAASyI,UAAT,GAAsB;AACpB,MAAI,CAACzI,IAAL,EAAW;AACT,UAAM,IAAI5C,KAAJ,CAAU,yCAAV,CAAN;AACD;;AAED,SAAO,+BAAgB4C,IAAhB,EAAsBsR,sBAAtB,CAA6C,uBAA7C,EAAsE,UAAUC,KAAV,EAAiB;AAC5FA,UAAMC,MAAN,CAAa,KAAb,EAAoBC,OAApB;AACAF,UAAMC,MAAN,CAAa,eAAb;AACD,GAHM,EAGJrY,IAHI,EAAP;AAID;;AAED,SAASoR,aAAT,CAAuBrQ,GAAvB,EAA4BkQ,aAA5B,EAA2C;AACzC,SAAOpK,KAAK,uBAAL,EACN0R,MADM,CACC,EAAExX,QAAF,EAAOkQ,4BAAP,EADD,EAENjR,IAFM,GAEC4G,GAFD,CAEK,CAFL,CAAP;AAGD;;AAED,SAASuK,aAAT,CAAuBpQ,GAAvB,EAA4B;AAC1B,SAAO8F,KAAK,uBAAL,EACNC,KADM,CACA,KADA,EACO/F,GADP,EAENyX,MAFM,CAEC,eAFD,EAGNxY,IAHM,GAGC4G,GAHD,CAGK,CAHL,EAIN5G,IAJM,CAID,eAAO;AACX,WAAOyY,OAAOA,IAAIxH,aAAlB;AACD,GANM,CAAP;AAOD;;AAED,SAASC,aAAT,CAAuBnQ,GAAvB,EAA4B;AAC1B,SAAO8F,KAAK,uBAAL,EACNC,KADM,CACA,KADA,EACO/F,GADP,EAEN2X,KAFM,CAEA,cAFA,EAGN1Y,IAHM,CAGD,eAAO;AACX,WAAOyY,OAAOA,IAAI,CAAJ,CAAP,IAAiBA,IAAI,CAAJ,EAAOC,KAAP,KAAiB,CAAzC;AACD,GALM,CAAP;AAMD;;AAEDjW,OAAOC,OAAP,GAAiB,UAAC2M,CAAD,EAAO;AACtBxI,SAAOwI,CAAP;AACA,SAAO,EAAEC,sBAAF,EAAc8B,4BAAd,EAA6BD,4BAA7B,EAA4CD,4BAA5C,EAAP;AACD,CAHD,C;;;;;;ACxCA,qC;;;;;;ACAA,0C;;;;;;ACAA,mC;;;;;;ACAA,uC;;;;;;ACAA,wC;;;;;;;;;ACAA;;;;AAEA;;;;AACA;;;;AACA;;;;;;AAEAzO,OAAOC,OAAP,GAAiB,UAACgE,EAAD,EAAKpG,SAAL,EAAmB;;AAElC,MAAMiH,QAAQ,qBAAMb,EAAN,EAAUpG,SAAV,CAAd;;AAEA,MAAMqY,gBAAgB,wBAAI;AACxBC,SAAK,KADmB;AAExBC,YAAQ,KAAK,EAAL,GAAU;AAFM,GAAJ,CAAtB;;AAKA,MAAMC,kBAAkB,SAAlBA,eAAkB,UAAW;AACjC,QAAM/U,SAAS7C,QAAQgV,MAAR,IAAkBhV,QAAQgV,MAAR,CAAehP,EAAhD;AACA,QAAMsB,MAAMtH,QAAQR,OAAR,IAAmBQ,QAAQR,OAAR,CAAgB8H,GAA/C;;AAEA,QAAIA,OAAO,CAACmQ,cAAcI,GAAd,CAAkBvQ,GAAlB,CAAZ,EAAoC;AAClC;AACAtH,cAAQ8X,gBAAR,GAA2B,IAA3B;AACD,KAHD,MAGO;AACL;AACAL,oBAAcM,GAAd,CAAkBzQ,GAAlB,EAAuB,IAAvB;AACD;;AAED,WAAOjB,MAAMD,qBAAN,CAA4BvD,MAA5B,CAAP;AACD,GAbD;;AAeAzD,YAAUwT,EAAV,CAAa,SAAb,EAAwB,aAAK;AAC3BgF,oBAAgBI,CAAhB,EACClZ,IADD,CACM,mBAAW;AACf;AACA0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,kBAAU,UADgB;AAE1B1E,cAAM,SAFoB;AAG1BiG,cAAMI,OAHoB;AAI1BhF,cAAM+W,EAAExY,OAAF,CAAUyB,IAJU;AAK1B3B,aAAK0Y;AALqB,OAA5B;AAOD,KAVD;AAWD,GAZD;;AAcA5Y,YAAUwT,EAAV,CAAa,YAAb,EAA2B,aAAK;AAC9BgF,oBAAgBI,CAAhB,EACClZ,IADD,CACM,mBAAW;AACf0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,kBAAU,UADgB;AAE1B1E,cAAM,aAFoB;AAG1BiG,cAAMI,OAHoB;AAI1BhF,cAAM+W,EAAExY,OAAF,CAAUoW,WAAV,CAAsB3S,MAAtB,GAA+B,cAJX;AAK1B3D,aAAK0Y;AALqB,OAA5B;AAOAA,QAAExY,OAAF,CAAUoW,WAAV,CAAsBxS,OAAtB,CAA8B,eAAO;AACnCoC,WAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,oBAAU,UADgB;AAE1B1E,gBAAMsY,IAAItY,IAFgB;AAG1BiG,gBAAMI,OAHoB;AAI1BhF,gBAAMiX,IAAIlY,OAAJ,CAAYH,GAAZ,GACJqY,IAAIlY,OAAJ,CAAYH,GADR,GAEFsN,KAAKsD,SAAL,CAAeyH,IAAIlY,OAAnB,CANsB;AAO1BV,eAAK4Y;AAPqB,SAA5B;AASD,OAVD;AAWD,KApBD;AAqBD,GAtBD;;AAwBA9Y,YAAUwT,EAAV,CAAa,UAAb,EAAyB,aAAK;AAC5BgF,oBAAgBI,CAAhB,EACClZ,IADD,CACM,mBAAW;AACf0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,kBAAU,UADgB;AAE1B1E,cAAM,UAFoB;AAG1BiG,cAAMI,OAHoB;AAI1BhF,cAAM+W,EAAEvX,QAAF,CAAWT,OAJS;AAK1BV,aAAK0Y;AALqB,OAA5B;;AAQA,UAAIA,EAAEvX,QAAF,CAAWT,OAAX,KAAuB,aAA3B,EAA0C;AACxC,YAAMmY,UAAU/Y,UAAUoN,SAAV,EAAhB;;AAEA,YAAI2L,QAAQzO,iBAAR,IAA6ByO,QAAQ3N,kBAAR,IAA8B,kBAA/D,EAAmF;AACjFhF,aAAGpG,SAAH,CAAagZ,QAAb,CAAsBnS,QAAQD,EAA9B,EAAkCmS,QAAQ1N,gBAA1C;AACD;;AAED,YAAI0N,QAAQzO,iBAAR,IAA6ByO,QAAQ3N,kBAAR,IAA8B,sBAA/D,EAAuF;AACrFhF,aAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,sBAAU,UADgB;AAE1B1E,kBAAM,UAFoB;AAG1BiG,kBAAMI,OAHoB;AAI1BhF,kBAAMkX,QAAQzN,oBAJY;AAK1BpL,iBAAK0Y;AALqB,WAA5B;AAOD;AACF;AACF,KA3BD;AA4BD,GA7BD;;AA+BA5Y,YAAUwT,EAAV,CAAa,aAAb,EAA4B,aAAK;AAC/BgF,oBAAgBI,CAAhB,EACClZ,IADD,CACM,mBAAW;AACf0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,kBAAU,UADgB;AAE1B1E,cAAM,aAFoB;AAG1BiG,cAAMI,OAHoB;AAI1BhF,cAAM+W,EAAExY,OAAF,CAAU8D,WAAV,CAAsBtD,OAJF;AAK1BV,aAAK0Y;AALqB,OAA5B;AAOD,KATD;AAUD,GAXD;;AAaA5Y,YAAUwT,EAAV,CAAa,UAAb,EAAyB,aAAK;;AAE5B,qBAAEtF,MAAF,CAAS,mBAAS7L,OAAlB,EAA2B2B,OAA3B,CAAmC,mBAAW;AAC5C,UAAMgN,YAAY3O,QAAQtC,KAAR,CAAcG,GAAd,CAAkBC,EAApC;AACA,UAAIyY,EAAEhD,MAAF,CAAShP,EAAT,KAAgBoK,SAAhB,IAA6B3O,QAAQtC,KAAR,CAAcG,GAAd,CAAkBkF,YAAnD,EAAiE;AAC/D,YAAI,iBAAEZ,QAAF,CAAWoU,EAAEjC,QAAF,CAAWsC,IAAtB,EAA4B5W,QAAQ6F,GAApC,CAAJ,EAA8C;AAC5C7F,kBAAQE,OAAR,CAAgBqW,CAAhB;AACA,iBAAO,mBAASvW,OAAT,CAAiBA,QAAQtC,KAAR,CAAcuD,IAA/B,CAAP;AACD;AACF;AACF,KARD;;AAUAkV,oBAAgBI,CAAhB,EACClZ,IADD,CACM,mBAAW;AACf0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,kBAAU,UADgB;AAE1B1E,cAAM,UAFoB;AAG1BiG,cAAMI,OAHoB;AAI1BhF,cAAM+W,EAAEjC,QAAF,CAAWuC,SAAX,CAAqBC,QAArB,EAJoB;AAK1BjZ,aAAK0Y;AALqB,OAA5B;AAOD,KATD;AAUD,GAtBD;;AAwBA5Y,YAAUwT,EAAV,CAAa,MAAb,EAAqB,aAAK;AACxB,qBAAEtF,MAAF,CAAS,mBAAS7L,OAAlB,EAA2B2B,OAA3B,CAAmC,mBAAW;AAC5C,UAAMgN,YAAY3O,QAAQtC,KAAR,CAAcG,GAAd,CAAkBC,EAApC;AACA,UAAIyY,EAAEhD,MAAF,CAAShP,EAAT,KAAgBoK,SAApB,EAA+B;AAC7B,YAAI3O,QAAQtC,KAAR,CAAcG,GAAd,CAAkBiF,QAAlB,IACC9C,QAAQ2F,SADT,IAEC3F,QAAQ2F,SAAR,IAAqB4Q,EAAEhC,IAAF,CAAOsC,SAFjC,EAE4C;AACxC7W,kBAAQE,OAAR,CAAgBqW,CAAhB;AACA,iBAAO,mBAASvW,OAAT,CAAiBA,QAAQtC,KAAR,CAAcuD,IAA/B,CAAP;AACH;AACF;AACF,KAVD;;AAYAkV,oBAAgBI,CAAhB,EACClZ,IADD,CACM,mBAAW;AACf0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,kBAAU,UADgB;AAE1B1E,cAAM,MAFoB;AAG1BiG,cAAMI,OAHoB;AAI1BhF,cAAM+W,EAAEhC,IAAF,CAAOsC,SAAP,CAAiBC,QAAjB,EAJoB;AAK1BjZ,aAAK0Y;AALqB,OAA5B;AAOD,KATD;AAUD,GAvBD;;AAyBA5Y,YAAUwT,EAAV,CAAa,iBAAb,EAAgC,aAAK;AACjCgF,oBAAgBI,CAAhB,EACGlZ,IADH,CACQ,mBAAW;AACf0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AACxB3T,kBAAU,UADc;AAExB1E,cAAM,iBAFkB;AAGxBiG,cAAMI,OAHkB;AAIxBhF,cAAM+W,EAAE/B,eAAF,CAAkBuC,kBAJA;AAKxBlZ,aAAK0Y;AALmB,OAA5B;AAOH,KATD;AAUH,GAXD;;AAaA5Y,YAAUwT,EAAV,CAAa,OAAb,EAAsB,aAAK;AACzBgF,oBAAgBI,CAAhB,EACClZ,IADD,CACM,mBAAW;AACf0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,kBAAU,UADgB;AAE1B1E,cAAM,OAFoB;AAG1BiG,cAAMI,OAHoB;AAI1BhF,cAAM+W,EAAE9B,KAAF,CAAQuC,GAJY;AAK1BnZ,aAAK0Y;AALqB,OAA5B;AAOD,KATD;AAUD,GAXD;;AAaA5Y,YAAUwT,EAAV,CAAa,UAAb,EAAyB,aAAK;AAC5BgF,oBAAgBI,CAAhB,EACClZ,IADD,CACM,mBAAW;AACf0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,kBAAU,UADgB;AAE1B1E,cAAM,UAFoB;AAG1BiG,cAAMI,OAHoB;AAI1BhF,cAAM+W,EAAE7B,QAAF,CAAWsC,GAJS;AAK1BnZ,aAAK0Y;AALqB,OAA5B;AAOD,KATD;AAUD,GAXD;;AAaA5Y,YAAUwT,EAAV,CAAa,SAAb,EAAwB,aAAI;AAC1BgF,oBAAgBI,CAAhB,EACClZ,IADD,CACM,mBAAU;AACd0G,SAAG0F,WAAH,CAAe+M,YAAf,CAA4B;AAC1B3T,kBAAU,UADgB;AAE1B1E,cAAM,SAFoB;AAG1BqB,cAAM,SAHoB;AAI1B4E,cAAMI,OAJoB;AAK1BmQ,iBAAS4B,EAAE5B,OALe;AAM1B9W,aAAK0Y;AANqB,OAA5B;AAQD,KAVD;AAWD,GAZD;AAcD,CAhND,C;;;;;;ACNA,sC;;;;;;;;;;;ACAA;;;;AACA;;;;AAEA;;;;;;AAEA,IAAMU,sBAAsB,iBAA5B;;AAEA,SAASC,cAAT,CAAwBjJ,OAAxB,EAAiCkJ,QAAjC,EAA2C;AACzC,SAAOC,oBAAoBnJ,OAApB,EAA6BkJ,QAA7B,EAAuCtS,GAAvC,CAA2C,kBAAU;AAC1D,QAAIqO,OAAO3U,OAAP,IAAkB2U,OAAOpR,KAAzB,IAAkC,iBAAEwL,KAAF,CAAQ4F,OAAO/U,IAAf,CAAtC,EAA4D;AAC1D,aAAOyC,OAAOC,MAAP,CAAcqS,MAAd,EAAsB,EAAE/U,MAAM,UAAR,EAAtB,CAAP;AACD;;AAED,WAAO+U,MAAP;AACD,GANM,CAAP;AAOD;;AAED,SAASkE,mBAAT,CAA6BC,GAA7B,EAAkCF,QAAlC,EAA4C;AAC1C,MAAI,CAAC,iBAAEzV,OAAF,CAAU2V,GAAV,CAAL,EAAqB;AACnB,UAAM,IAAI/V,KAAJ,CAAU,uCAAV,CAAN;AACD;;AAED,SAAO+V,IAAIxS,GAAJ,CAAQ,cAAM;AACnB,QAAI,iBAAEjB,QAAF,CAAW0T,EAAX,KAAkBL,oBAAoB5V,IAApB,CAAyBiW,EAAzB,CAAtB,EAAoD;AAAA,kCAC1BL,oBAAoBM,IAApB,CAAyBD,EAAzB,CAD0B;AAAA;AAAA,UAC3C/Y,OAD2C;AAAA,UAClCiB,IADkC;;AAGlD;;;AACA,UAAIjB,QAAQiZ,UAAR,CAAmB,GAAnB,CAAJ,EAA6B;AAC3BjZ,kBAAU4Y,WAAW5Y,OAArB;AACD;;AAED,aAAO;AACLuD,eAAOtC,IADF;AAELjB,iBAASA,QAAQiO,WAAR;AAFJ,OAAP;AAID;;AAED,WAAO8K,EAAP;AACD,GAhBM,CAAP;AAiBD;;AAED,SAASG,YAAT,CAAsBvW,GAAtB,EAA2BiW,QAA3B,EAAqC;AACnC,MAAI,CAAC,iBAAE5U,aAAF,CAAgBrB,GAAhB,CAAL,EAA2B;AACzB,WAAOA,GAAP;AACD;;AAED,SAAO,iBAAEwW,SAAF,CAAYxW,GAAZ,EAAiB,UAACkM,KAAD,EAAQC,GAAR,EAAgB;AACtC,QAAI,iBAAE9K,aAAF,CAAgB6K,KAAhB,CAAJ,EAA4B;AAC1B,aAAOqK,aAAarK,KAAb,EAAoB+J,QAApB,CAAP;AACD,KAFD,MAEO,IAAI,iBAAEzV,OAAF,CAAU0L,KAAV,CAAJ,EAAsB;AAC3B,UAAIC,QAAQ,SAAZ,EAAuB;AACrB,eAAOoK,aAAaP,eAAe9J,KAAf,EAAsB+J,QAAtB,CAAb,CAAP;AACD;AACD,aAAO/J,MAAMvI,GAAN,CAAU;AAAA,eAAK4S,aAAanP,CAAb,EAAgB6O,QAAhB,CAAL;AAAA,OAAV,CAAP;AACD,KALM,MAKA;AACL,aAAO/J,KAAP;AACD;AACF,GAXM,CAAP;AAYD;;AAED,SAASuK,SAAT,CAAmBja,KAAnB,EAA0B;AACxB,MAAI0D,SAAS,iBAAE6C,GAAF,CAAMvG,KAAN,EAAa,aAAb,KACR,iBAAEuG,GAAF,CAAMvG,KAAN,EAAa,YAAb,CADQ,IAER,iBAAEuG,GAAF,CAAMvG,KAAN,EAAa,QAAb,CAFQ,IAGR,iBAAEuG,GAAF,CAAMvG,KAAN,EAAa,UAAb,CAHQ,IAIR,iBAAEuG,GAAF,CAAMvG,KAAN,EAAa,SAAb,CAJQ,IAKR,iBAAEuG,GAAF,CAAMvG,KAAN,EAAa,aAAb,CALL;;AAOA,MAAI,CAAC0D,MAAL,EAAa;AACX,UAAM,IAAIE,KAAJ,CAAU,8CAAV,CAAN;AACD;;AAED,MAAIF,OAAOoW,UAAP,CAAkB,WAAlB,CAAJ,EAAoC;AAClC,WAAOpW,OAAOwW,MAAP,CAAc,YAAYpW,MAA1B,CAAP;AACD;;AAED,SAAOJ,MAAP;AACD;;AAED,SAASyW,gBAAT,OAA2D;AAAA,MAAhCna,KAAgC,QAAhCA,KAAgC;AAAA,MAAzByZ,QAAyB,QAAzBA,QAAyB;AAAA,MAAfW,WAAe,QAAfA,WAAe;;AACzD,MAAMC,MAAMnX,OAAOC,MAAP,CAAc,EAAd,EAAkBiX,WAAlB,CAAZ,CADyD,CACd;;AAE3C;AACA;AACA;;AAEA,MAAME,cAAc,CAClB,eADkB,EAElB,UAFkB,EAGlB,cAHkB,EAIlB,QAJkB,EAKlB,KALkB,EAMlB,oBANkB,EAOlB,IAPkB,CAApB;;AAUA,MAAMpV,UAAU,iBAAEqV,IAAF,CAAOH,WAAP,EAAoBE,WAApB,CAAhB;;AAjByD;AAAA;AAAA;;AAAA;AAmBzD,yBAAiBA,WAAjB,8HAA8B;AAAA,UAArBE,IAAqB;;AAC5B,aAAOH,IAAIG,IAAJ,CAAP;AACD;AArBwD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAuBzD,MAAItV,QAAQ5E,aAAZ,EAA2B;AACzB4E,YAAQ5E,aAAR,GAAwBoZ,oBAAoBxU,QAAQ5E,aAA5B,EAA2CmZ,QAA3C,CAAxB;AACD;;AAED;AACA;AACA;;AAEA,MAAI,CAAC,iBAAE7J,KAAF,CAAQwK,YAAYtV,aAApB,CAAL,EAAyC;AACvC,QAAMoR,OAAO6D,aAAaM,GAAb,EAAkBZ,QAAlB,CAAb;AACA,WAAO,kBAAQ/T,cAAR,CAAuBuU,UAAUja,KAAV,CAAvB,EAAyCkW,IAAzC,EAA+ChR,OAA/C,CAAP;AACD;;AAlCwD,aAoCxC,CAAC,OAAD,EAAU,OAAV,EAAmB,OAAnB,EAA4B,MAA5B,CApCwC;AAoCzD,2CAAsD;AAAjD,QAAIuV,eAAJ;AACH,QAAI,CAAC,iBAAE7K,KAAF,CAAQwK,YAAYK,IAAZ,CAAR,CAAL,EAAiC;AAC/B,aAAO,kBAAQnV,gBAAR,CAAyB2U,UAAUja,KAAV,CAAzB,EAA2Cya,IAA3C,EAAiDJ,IAAII,IAAJ,CAAjD,EAA4DvV,OAA5D,CAAP;AACD;AACF;;AAED,MAAI,CAAC,iBAAE0K,KAAF,CAAQwK,YAAY1J,UAApB,CAAL,EAAsC;AACpC,WAAO,kBAAQpL,gBAAR,CACL2U,UAAUja,KAAV,CADK,EAELoa,YAAY3Z,IAAZ,IAAoB2Z,YAAY1J,UAF3B,EAGL2J,IAAI3Z,GAAJ,IAAW0Z,YAAY1J,UAHlB,EAILxL,OAJK,CAAP;AAKD;;AAED,MAAI,CAAC,iBAAE0K,KAAF,CAAQwK,YAAYtY,IAApB,CAAL,EAAgC;AAC9B,WAAO,kBAAQmD,UAAR,CAAmBgV,UAAUja,KAAV,CAAnB,EAAqCoa,YAAYtY,IAAjD,EAAuDoD,OAAvD,CAAP;AACD;;AAED;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA,MAAMwV,SAAS,eAAKC,OAAL,CAAaP,WAAb,EAA0B,KAA1B,EAAiC,CAAjC,CAAf;AACA,QAAM,IAAIxW,KAAJ,+DAAqE6V,QAArE,YAAmFiB,MAAnF,CAAN;AACD;;AAED;AACA;AACA;;AAEA,SAASE,YAAT,GAAwB;AACtB,SAAO,CACL;AACEna,UAAM,uBADR;AAEEoa,cAAU;AAFZ,GADK,EAIH;AACApa,UAAM,0BADN;AAEAoa,cAAU;AAFV,GAJG,EAOH;AACApa,UAAM,uBADN;AAEAoa,cAAU;AAFV,GAPG,EAUH;AACApa,UAAM,8BADN;AAEAoa,cAAU;AAFV,GAVG,EAaH;AACApa,UAAM,sBADN;AAEAoa,cAAU;AAFV,GAbG,EAgBH;AACApa,UAAM,oBADN;AAEAoa,cAAU;AAFV,GAhBG,EAmBH;AACApa,UAAM,oBADN;AAEAoa,cAAU;AAFV,GAnBG,EAsBH;AACApa,UAAM,oBADN;AAEAoa,cAAU;AAFV,GAtBG,EAyBH;AACApa,UAAM,qBADN;AAEAoa,cAAU;AAFV,GAzBG,CAAP;AA8BD;;AAEDzY,OAAOC,OAAP,GAAiB,cAAM;AAAA,aACY,iBAAEyY,EAAF,CAAKzU,EAAL,EAAS,CAAC,KAAD,EAAQ,uBAAR,CAAT,CADZ;AAAA;AAAA,MACd0U,GADc;AAAA,MACTC,iBADS;;AAGrBD,SAAOC,iBAAP,IAA4BA,kBAAkB;AAC5C7V,cAAU,UADkC;AAE5CgV,qBAAiB;AAAA,aAAQA,iBAAgBjX,OAAOC,MAAP,CAAc,EAAd,EAAkB4E,IAAlB,EAAwB,EAAE1B,MAAF,EAAxB,CAAhB,CAAR;AAAA,KAF2B;AAG5C4U,eAAWL;AAHiC,GAAlB,CAA5B;AAKD,CARD,C;;;;;;ACxLA,iC;;;;;;ACAA,08B","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/Users/slvn/bots/modules_bck/botpress-messenger\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 675ddd23a422d9546eb6","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 1\n// module chunks = 0","const handlePromise = (next, promise) => {\n  return promise.then(res => {\n    next()\n    return res\n  })\n  .catch(err => {\n    next(err)\n    throw err\n  })\n}\n\nconst handleText = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTextMessage(\n    event.raw.to,\n    event.raw.message,\n    event.raw.quick_replies,\n    event.raw))\n}\n\nconst handleAttachment = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendAttachment(\n    event.raw.to,\n    event.raw.type,\n    event.raw.url,\n    event.raw.quick_replies,\n    event.raw))\n}\n\nconst handleTemplate = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTemplate(\n    event.raw.to,\n    event.raw.payload,\n    event.raw))\n}\n\nconst handleTyping = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTypingIndicator(\n    event.raw.to,\n    event.raw.typing))\n}\n\nconst handleSeen = (event, next, messenger) => {\n  return handlePromise(next, \n    messenger.sendAction(event.raw.to, 'mark_seen'))\n}\n\nconst handleGetStarted = (event, next, messenger) => {\n  if (event.raw.enabled) {\n    return handlePromise(next, \n      messenger.setGetStartedButton(event.raw.postback))\n  } else {\n    return handlePromise(next, messenger.deleteGetStartedButton())\n  }\n}\n\nconst handlePersistentMenu = (event, next, messenger) => {\n  if (event.raw.delete) {\n    return handlePromise(next, messenger.deletePersistentMenu())\n  } else {\n    return handlePromise(next, \n      messenger.setPersistentMenu(event.raw.elements))\n  }\n}\n\nconst handleGreetingText = (event, next, messenger) => {\n  if (event.raw.text) {\n    return handlePromise(next, \n      messenger.setGreetingText(event.raw.text))\n  } else {\n    return handlePromise(next, messenger.deleteGreetingText(event.raw.text))\n  }\n}\n\nconst handleWhitelistedDomains = (event, next, messenger) => {\n  return handlePromise(next, \n    messenger.setWhitelistedDomains(event.raw.domains))\n}\n\nmodule.exports = {\n  'text': handleText,\n  'attachment': handleAttachment,\n  'template': handleTemplate,\n  'typing': handleTyping,\n  'seen': handleSeen,\n  'greeting_text': handleGreetingText,\n  'persistent_menu': handlePersistentMenu,\n  'whitelisted_domains': handleWhitelistedDomains,\n  'get_started': handleGetStarted,\n  pending: {}\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/outgoing.js","import _ from 'lodash'\nimport Promise from 'bluebird'\nimport outgoing from './outgoing'\n\nconst create = obj => {\n  let resolve = null\n  let reject = null\n  const promise = new Promise((r, rj) => {\n    resolve = r\n    reject = rj\n  })\n\n  const messageId = new Date().toISOString() + Math.random()\n  \n  const newEvent = Object.assign({\n    _promise: promise,\n    _resolve: resolve,\n    _reject: reject,\n    __id: messageId\n  }, obj)\n\n  outgoing.pending[messageId] = {\n    event: newEvent,\n    resolve: resolve,\n    reject: reject\n  }\n\n  return newEvent\n}\n\nconst validateUserId = (userId) => {\n  if (!/[0-9]+/.test(userId)) {\n    throw new Error('Invalid userId')\n  }\n}\n\nconst validateText = (text) => {\n  if (typeof(text) !== 'string' || text.length > 640) {\n    throw new Error('Text must be a string less than 640 chars.')\n  }\n}\n\nconst validateQuickReplies = (quick_replies) => {\n  if (!_.isArray(quick_replies)) {\n    throw new Error('quick_replies must be an array')\n  }\n\n  _.forEach(quick_replies, validateQuickReply)\n}\n\nconst validateQuickReply = (quick_reply) => {\n  if (typeof(quick_reply) !== 'string') {\n    if (!quick_reply || typeof(quick_reply.title) !== 'string') {\n      throw new Error('Expected quick_reply to be a string or an object' +\n        'with a title.')\n    }\n  }\n}\n\nconst validateTyping = (typing) => {\n  if (!_.isBoolean(typing) && !_.isNumber(typing)) {\n    throw new Error('Expected typing to be a boolean of a number')\n  }\n}\n\nconst validateAttachmentType = (type) => {\n  if (typeof(type) !== 'string') {\n    throw new Error('Expected attachment type to be a text')\n  }\n\n  if (!_.includes(['image', 'video', 'audio', 'file'], type.toLowerCase())) {\n    throw new Error('Invalid attachment type')\n  }\n}\n\nconst validateUrl = (url) => {\n  if (typeof(url) !== 'string') {\n    throw new Error('Expected URL to be a string')\n  }\n}\n\nconst validateTemplatePayload = (payload) => {\n  if (!_.isPlainObject(payload)) {\n    throw new Error('Template payload must be a plain object')\n  }\n\n  if (typeof(payload.template_type) !== 'string') {\n    throw new Error('\"template_type\" must be set')\n  }\n}\n\nconst validatePersistentMenu = (elements) => {\n  if (!_.isArray(elements)) {\n    throw new Error('Expected elements to be an array')\n  }\n\n  _.forEach(elements, (element) => {\n    if (!_.isPlainObject(element)) {\n      throw new Error('Expected element to be a plain object')\n    }\n  })\n}\n\nconst createText = (userId, text, options) => {\n  validateUserId(userId)\n  validateText(text)\n\n  if (options && options.quick_replies) {\n    validateQuickReplies(options.quick_replies)\n  }\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'text',\n    text: text,\n    raw: {\n      to: userId,\n      message: text,\n      typing: (options && options.typing),\n      quick_replies: options && options.quick_replies,\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  })\n}\n\nconst createAttachment = (userId, type, url, options) => {\n  validateUserId(userId)\n  validateAttachmentType(type)\n  \n  if ( _.isNull(url) && !(options && options.attachmentId) ) {\n    throw new Error('If URL is null, you must pass an attachment_id on options object')\n  }\n  else if ( options && options.attachmentId ) {\n    validateText(options.attachmentId)\n  }\n  else {\n    validateUrl(url)\n  }\n\n  if (options && options.quick_replies) {\n    validateQuickReplies(options.quick_replies)\n  }\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'attachment',\n    text: 'Attachment (' + type + ') : ' + url,\n    raw: {\n      to: userId,\n      type: type,\n      url: url,\n      isReusable: (options && options.isReusable),\n      attachmentId: (options && options.attachmentId),\n      typing: (options && options.typing),\n      quick_replies: options && options.quick_replies,\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  })\n}\n\nconst createTemplate = (userId, payload, options) => {\n  validateUserId(userId)\n  validateTemplatePayload(payload)\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'template',\n    text: 'Template (' + payload.template_type + ')',\n    raw: {\n      to: userId,\n      payload: payload,\n      typing: (options && options.typing),\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  })\n}\n\nconst createTyping = (userId, typing) => {\n  validateUserId(userId)\n  validateTyping(typing)\n\n  return create({\n    platform: 'facebook',\n    type: 'typing',\n    text: 'Typing: ' + typing,\n    raw: {\n      to: userId,\n      typing: typing\n    }\n  })\n}\n\nconst createSeen = (userId) => {\n  validateUserId(userId)\n\n  return create({\n    platform: 'facebook',\n    type: 'seen',\n    text: 'Mark as seen',\n    raw: {\n      to: userId\n    }\n  })\n}\n\nconst createPersistentMenu = (elements) => {\n  if (!elements) {\n    return create({\n      platform: 'facebook',\n      type: 'persistent_menu',\n      text: 'Delete the persistent menu',\n      raw: {\n        delete: true\n      }\n    })\n  }\n\n  validatePersistentMenu(elements)\n  return create({\n    platform: 'facebook',\n    type: 'persistent_menu',\n    text: 'Set persistent menu: ' + elements.length + ' items',\n    raw: {\n      delete: false,\n      elements: elements\n    }\n  })\n}\n\nconst createGreetingText = (text) => {\n  if (text && text.length > 160) {\n    throw new Error('Greeting text must be less than 160 chars')\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'greeting_text',\n    text: 'Set greeting text: ' + text,\n    raw: {\n      text: text\n    }\n  })\n}\n\nconst createGetStarted = (postback) => {\n  return create({\n    platform: 'facebook',\n    type: 'get_started',\n    text: 'Setting get started button: ' + !!postback,\n    raw: {\n      enabled: !!postback,\n      postback: postback\n    }\n  })\n}\n\nconst createWhitelistedDomains = (domains) => {\n  if (domains && !_.every(domains, _.isString)) {\n    throw new Error('Expected domains to be a list of string')\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'whitelisted_domains',\n    text: 'Setting whitelisted domains',\n    raw: {\n      domains: domains\n    }\n  })\n}\n\nmodule.exports = {\n  createText,\n  createAttachment,\n  createTemplate,\n  createTyping,\n  createSeen,\n  createGetStarted,\n  createPersistentMenu,\n  createGreetingText,\n  createWhitelistedDomains\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/actions.js","const _ = require('lodash')\n\nmodule.exports = function(bp, messenger) {\n\n  function profileToDbEntry(profile) {\n    return {\n      id: profile.id,\n      platform: 'facebook',\n      gender: profile.gender,\n      timezone: profile.timezone,\n      locale: profile.locale,\n      picture_url: profile.profile_pic,\n      first_name: profile.first_name,\n      last_name: profile.last_name\n    }\n  }\n\n  function dbEntryToProfile(db) {\n    return {\n      gender: db.gender,\n      timezone: db.timezone,\n      locale: db.locale,\n      profile_pic: db.picture_url,\n      first_name: db.first_name,\n      last_name: db.last_name,\n      id: db.userId\n    }\n  }\n\n  async function getOrFetchUserProfile(userId) {\n    const knex = await bp.db.get()\n\n    const user = await knex('users')\n      .where({ platform: 'facebook', 'userId': userId })\n      .then().get(0).then()\n\n    if (user) {\n      return dbEntryToProfile(user)\n    }\n\n    const profile = Object.assign(await messenger.getUserProfile(userId), { id: userId })\n    await bp.db.saveUser(profileToDbEntry(profile))\n\n    return profile\n  }\n\n  async function getAllUsers() {\n    const knex = await bp.db.get()\n\n    const users = await knex('users')\n      .where({ platform: 'facebook' })\n      .then()\n\n    return (users || []).map(dbEntryToProfile)\n  }\n\n  return { getOrFetchUserProfile, getAllUsers }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/users.js","/* global __dirname */\n\nimport checkVersion from 'botpress-version-manager'\n\nimport path from 'path'\nimport fs from 'fs'\nimport _ from 'lodash'\n\nimport uuid from 'uuid'\nimport Promise from 'bluebird'\n\nimport Messenger from './messenger'\nimport actions from './actions'\nimport outgoing from './outgoing'\nimport incoming from './incoming'\nimport Users from './users'\nimport UMM from './umm'\n\nimport configTemplate from 'raw-loader!./botpress-messenger.config.yml'\n\nlet messenger = null\nconst outgoingPending = outgoing.pending\n\nlet users = null\n\nconst outgoingMiddleware = (event, next) => {\n  if (event.platform !== 'facebook') {\n    return next()\n  }\n\n  if (!outgoing[event.type]) {\n    return next('Unsupported event type: ' + event.type)\n  }\n\n  const setValue = method => (...args) => {\n    if (event.__id && outgoingPending[event.__id]) {\n\n      if (args && args[0] && args[0].message_id) {\n        outgoingPending[event.__id].timestamp = new Date().getTime() - 1000\n        outgoingPending[event.__id].mid = args[0].message_id\n      }\n\n      if (method === 'resolve' && (event.raw.waitDelivery || event.raw.waitRead)) {\n        // We skip setting this value because we wait\n      } else {\n        outgoingPending[event.__id][method].apply(null, args)\n        delete outgoingPending[event.__id]\n      }\n    }\n  }\n\n  outgoing[event.type](event, next, messenger)\n  .then(setValue('resolve'), setValue('reject'))\n}\n\nconst initializeMessenger = (bp, configurator) => {\n  return configurator.loadAll()\n  .then(config => {\n    messenger = new Messenger(bp, config)\n\n    users = Users(bp, messenger)\n\n    const configErrors = messenger.getConfigErrors()\n    const enabled = config.enabled\n\n    if (!enabled) {\n      return bp.logger.warn('[botpress-messenger] Connection disabled.')\n    }\n\n    if (configErrors.length) {\n      for (var err of configErrors) {\n        bp.logger.warn('[botpress-messenger] ' + err.message)\n      }\n\n      return bp.notifications.send({\n        level: 'error',\n        message: 'Error updating Messenger App. Please see logs for details.'\n      })\n    }\n\n    return messenger.connect()\n    .then(() => messenger.updateSettings())\n    .then(() => bp.notifications.send({\n      level: 'success',\n      message: 'Configuration and webhook updated'\n    }))\n    .catch(err => {\n      bp.logger.error(err)\n      return bp.notifications.send({\n        level: 'error',\n        message: 'Error updating Messenger App. Please see logs for details.'\n      })\n    })\n\n  })\n}\n\nconst createConfigFile = (bp) => {\n  const name = 'botpress-messenger.config.yml'\n  const file = path.join(bp.projectLocation, name)\n\n  if (!fs.existsSync(file)) {\n    fs.writeFileSync(file, configTemplate)\n\n    bp.notifications.send({\n      level: 'info',\n      message: name + ' has been created, fill it'\n    })\n  }\n}\n\nmodule.exports = {\n\n  config: {\n    applicationID: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_ID' },\n    accessToken: { type: 'string', required: true, default: '', env: 'MESSENGER_ACCESS_TOKEN' },\n    appSecret: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_SECRET' },\n    verifyToken: { type: 'string', required: false, default: uuid.v4() },\n    enabled: { type: 'bool', required: true, default: true },\n    validated: { type: 'bool', required: false, default: false }, // deprecated --> automaticcaly reconfigure on start (config = enabled)\n    connected: { type: 'bool', required: false, default: false }, // deprecated --> automaticcaly reconfigure on start (config = enabled)\n    hostname: { type: 'string', required: false, default: '', env: 'MESSENGER_HOST' },\n    homepage: { type: 'string' },\n    displayGetStarted: { type: 'bool', required: false, default: true },\n    greetingMessage: { type: 'string', required: false, default: 'Default greeting message' },\n    persistentMenu: { type: 'bool', required: false, default: false },\n    persistentMenuItems: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    composerInputDisabled: { type: 'bool', required: false, default: false },\n    automaticallyMarkAsRead: { type: 'bool', required: false, default: true },\n    targetAudience: { type: 'string', required: true, default: 'openToAll'},\n    targetAudienceOpenToSome: { type: 'string', required: false },\n    targetAudienceCloseToSome: { type: 'string', required: false },\n    trustedDomains: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    autoRespondGetStarted: { type: 'bool', required: false, default: true }, // deprecated\n    autoResponse: { type: 'string', required: false, default: 'Hello!' },     // deprecated\n    autoResponseOption: { type: 'string', required: false, default: 'autoResponseText' },\n    autoResponseText: { type: 'string', required: false, default: 'Hello, human!' },\n    autoResponsePostback: { type: 'string', required: false, default: 'YOUR_POSTBACK' },\n    paymentTesters: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    chatExtensionHomeUrl: { type: 'string', required: false, default: '' },\n    chatExtensionInTest: { type: 'bool', required: false, default: true },\n    chatExtensionShowShareButton: { type: 'bool', required: false, default: false },\n    webhookSubscriptionFields: { \n      type: 'any', \n      required: true, \n      default: [\n        'message_deliveries',\n        'message_reads',\n        'messages',\n        'messaging_optins',\n        'messaging_postbacks',\n        'messaging_referrals'\n      ]\n    }\n  },\n\n  init: function(bp) {\n\n    checkVersion(bp, __dirname)\n\n    bp.middlewares.register({\n      name: 'messenger.sendMessages',\n      type: 'outgoing',\n      order: 100,\n      handler: outgoingMiddleware,\n      module: 'botpress-messenger',\n      description: 'Sends out messages that targets platform = messenger.' +\n      ' This middleware should be placed at the end as it swallows events once sent.'\n    })\n\n    bp.messenger = {}\n    _.forIn(actions, (action, name) => {\n\n      const applyFn = fn => function() {\n        var msg = action.apply(this, arguments)\n        const promise = msg._promise\n        return fn && fn(msg, promise)\n      }\n\n      const deprecate = fn => function() {\n        return (bp.lts && bp.lts.deprecate({\n          module: 'botpress-messenger',\n          message: 'create___ and send___ methods have been deprecated in favor of UMM and will be officially removed in Botpress v2.0',\n          referenceUrl: 'https://botpress.io/docs/foundamentals/umm.html'\n        }, fn)) || fn.apply(this, arguments)\n      }\n\n      var sendName = name.replace(/^create/, 'send')\n      bp.messenger[sendName] = deprecate(Promise.method(applyFn((msg, promise) => bp.middlewares.sendOutgoing(msg) && promise)))\n      bp.messenger[name] = deprecate(applyFn(msg => msg))\n    })\n\n    createConfigFile(bp)\n    UMM(bp) // Initializes Messenger in the UMM\n  },\n\n  ready: function(bp, config) {\n    initializeMessenger(bp, config)\n    .then(() => {\n      incoming(bp, messenger)\n\n      bp.messenger._internal = messenger\n\n      const router = bp.getRouter('botpress-messenger')\n\n      router.get('/config', (req, res) => {\n        res.send(messenger.getConfig())\n      })\n\n      router.post('/config', (req, res) => {\n        messenger.setConfig(req.body)\n        config.saveAll(messenger.getConfig())\n        .then(() => messenger.updateSettings())\n        .then(() => res.sendStatus(200))\n        .catch((err) => {\n          res.status(500).send({ message: err.message })\n        })\n      })\n\n      router.post('/connection', (req, res) => {\n        if (messenger.getConfig().connected) {\n          messenger.disconnect()\n          .then(() => res.sendStatus(200))\n          .catch((err) => res.status(500).send({ message: err.message }))\n        } else {\n          messenger.connect()\n          .then(() => res.sendStatus(200))\n          .catch((err) => res.status(500).send({ message: err.message }))\n        }\n      })\n\n      router.post('/validation', (req, res) => {\n        messenger.sendValidationRequest()\n        .then((json) => {\n          res.send(json)\n        })\n        .catch((err) => {\n          res.status(500).send({ message: err.message })\n        })\n      })\n\n      router.get('/homepage', (req, res) => {\n        const packageJSON = JSON.parse(fs.readFileSync(path.join(__dirname, '../package.json')))\n        res.send({ homepage: packageJSON.homepage })\n      })\n\n      router.get('/users', (req, res)=> {\n        users.getAllUsers()\n        .then((values) => {\n          res.send(values)\n        })\n        .catch((err) => res.status.send(500).send({ message:err.message }))\n      })\n\n      router.post('/remove_payment_tester', (req, res) => {\n        messenger.deletePaymentTester(req.body.payment_tester)\n          .then((json)=> {\n            res.send(json)\n          })\n          .catch((err) => {\n            res.status(500).send({ message: err.message })\n          })\n      })\n\n      router.get('/facebook_page', (req, res) => {\n        messenger._getPage()\n          .then((json) => {\n            res.send(json)\n          })\n          .catch((err) => {\n            res.status(500).send({ message: err.message })\n          })\n      })\n\n    })\n\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"uuid\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"uuid\"\n// module id = 10\n// module chunks = 0","/**\n * Messenger\n *\n * This file contains one class Messenger, which in charge of communication between\n * botpress and fb messenger.\n *\n */\n\nconst Promise = require('bluebird')\nconst EventEmitter = require('eventemitter2')\nconst crypto = require('crypto')\nconst fetch = require('node-fetch')\nconst _ = require('lodash')\nconst bodyParser = require('body-parser')\n\nimport DB from './db'\n\nfetch.promise = Promise\n\nconst normalizeString = function(str) {\n  return str.replace(/[^a-zA-Z0-9]+/g, '').toUpperCase()\n}\n\nlet db = null\n\nclass Messenger extends EventEmitter {\n  constructor(bp, config) {\n    super()\n    if (!bp || !config) {\n      throw new Error('You need to specify botpress and config')\n    }\n\n    this.setConfig(config)\n    this.bp = bp\n\n    bp.db.get()\n    .then(k => {\n      db = DB(k)\n      db.initialize()\n    })\n\n    this.app = bp.getRouter('botpress-messenger', {\n      'bodyParser.json': false,\n      'auth': req => !/\\/webhook/i.test(req.originalUrl)\n    })\n\n    this.app.use(bodyParser.json({\n      verify: this._verifyRequestSignature.bind(this)\n    }))\n\n    this._initWebhook()\n  }\n\n  setConfig(config) {\n    this.config = Object.assign({}, this.config, config)\n  }\n\n  getConfig() {\n    return this.config\n  }\n\n  getConfigErrors() {\n    const errors = []\n    const required = ['applicationID', 'accessToken', 'appSecret', 'hostname', 'verifyToken']\n\n    _.forEach(this.config, (value, key) => {\n      if (_.includes(required, key) && (_.isNil(value) || _.isEmpty(value))) {\n        errors.push({\n          key: key,\n          message: `Configuration is incomplete, ${key} needs to be defined. See \"./botpress-messenger.config.yml\".`\n        })\n      }\n    })\n\n    return errors\n  }\n\n  connect() {\n    return this._setupNewWebhook()\n    .then(() => this._subscribePage())\n  }\n\n  disconnect() {\n    return this._unsubscribePage()\n  }\n\n  sendTextMessage(recipientId, text, quickReplies, options) {\n    const message = { text }\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\n      message.quick_replies = formattedQuickReplies\n    }\n    return this.sendMessage(recipientId, message, options)\n  }\n\n  sendButtonTemplate(recipientId, text, buttons, options) {\n    const payload = {\n      template_type: 'button',\n      text\n    }\n    const formattedButtons = this._formatButtons(buttons)\n    payload.buttons = formattedButtons\n    return this.sendTemplate(recipientId, payload, options)\n  }\n\n  sendGenericTemplate(recipientId, elements, options) {\n    const payload = {\n      template_type: 'generic',\n      elements\n    }\n    return this.sendTemplate(recipientId, payload, options)\n  }\n\n  sendTemplate(recipientId, payload, options) {\n    const message = {\n      attachment: {\n        type: 'template',\n        payload\n      }\n    }\n    return this.sendMessage(recipientId, message, options)\n  }\n\n  async sendAttachment(recipientId, type, url, quickReplies, options) {\n    const message = {\n      attachment: {\n        type: type,\n        payload: {}\n      }\n    }\n\n    if (options.isReusable && _.isBoolean(options.isReusable)) {\n      message.attachment.payload.is_reusable = options.isReusable\n    }\n\n    if (options.attachmentId){\n      message.attachment.payload = {\n        attachment_id: options.attachmentId,\n      }\n    } else if (options.isReusable && await db.hasAttachment(url)) {\n      const attachmentId = await db.getAttachment(url)\n\n      message.attachment.payload = {\n        attachment_id: attachmentId\n      }\n    } else {\n      message.attachment.payload.url = url\n    }\n\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\n      message.quick_replies = formattedQuickReplies\n    }\n\n    return this.sendMessage(recipientId, message, options)\n    .then(res => {\n      if (res && res.attachment_id) {\n        db.addAttachment(url, res.attachment_id)\n      }\n    })\n  }\n\n  sendAction(recipientId, action) {\n    return this.sendRequest({\n      recipient: {\n        id: recipientId\n      },\n      sender_action: action\n    })\n  }\n\n  sendMessage(recipientId, message, options) {\n    const req = () => this.sendRequest({\n      recipient: {\n        id: recipientId\n      },\n      message\n    })\n\n    if (options && options.typing) {\n      const autoTimeout = (message && message.text) ? 500 + message.text.length * 10 : 1000\n      const timeout = (typeof options.typing === 'number') ? options.typing : autoTimeout\n      return this.sendTypingIndicator(recipientId, timeout).then(req)\n    }\n\n    return req()\n  }\n\n  sendValidationRequest() {\n    const applicationID = this.config.applicationID\n    const accessToken = this.config.accessToken\n\n    return fetch(`https://graph.facebook.com/v2.7/${applicationID}/subscriptions_sample`, {\n      method: 'POST',\n      headers: {'Content-Type': 'application/json'},\n      body: JSON.stringify({\n        object_id: applicationID,\n        object: 'page',\n        field: 'messages',\n        custom_fields: { page_id: applicationID },\n        access_token: accessToken\n      })\n    })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n  }\n\n  sendRequest(body, endpoint, method) {\n    endpoint = endpoint || 'messages'\n    method = method || 'POST'\n\n    const url = `https://graph.facebook.com/v2.7/me/${endpoint}`\n    return fetch(`${url}?access_token=${this.config.accessToken}`, {\n      method,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(body)\n    })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .then(json => {\n      this._handleEvent('raw_send_request', { url, token: this.config.accessToken, body, endpoint, method, response: json })\n      return json\n    })\n  }\n\n  sendThreadRequest(body, method) {\n    return this.sendRequest(body, 'thread_settings', method)\n  }\n\n  sendTypingIndicator(recipientId, milliseconds) {\n    let timeout = !milliseconds || isNaN(milliseconds) ? 0 : milliseconds\n    timeout = Math.min(20000, timeout)\n\n    if (milliseconds === true) {\n      timeout = 1000\n    }\n\n    const before = timeout > 0\n      ? Promise.resolve(this.sendAction(recipientId, 'typing_on'))\n      : Promise.resolve(true)\n\n    return before\n    .delay(timeout + 1000)\n    .then(() => this.sendAction(recipientId, 'typing_off'))\n  }\n\n  getUserProfile(userId) {\n    const url = `https://graph.facebook.com/v2.7/${userId}?fields=first_name,last_name,profile_pic,locale,timezone,gender&access_token=${this.config.accessToken}`\n    return fetch(url)\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .catch(err => console.log(`Error getting user profile: ${err}`))\n  }\n\n  createTargetAudienceSetting() {\n    var setting = { target_audience: {} }\n\n    switch(this.config.targetAudience){\n      case 'openToAll':\n        setting.target_audience.audience_type = 'all'\n        break;\n      case 'openToSome':\n        var countriesWhitelist = this.config.targetAudienceOpenToSome.split(/\\, ?/g);\n        setting.target_audience.audience_type = 'custom'\n        setting.target_audience.countries = {\n          whitelist: countriesWhitelist\n        }\n        break;\n      case 'closeToSome':\n        setting.target_audience.audience_type = 'custom'\n        var countriesBlacklist = this.config.targetAudienceCloseToSome.split(/\\, ?/g);\n        setting.target_audience.countries = {\n          blacklist: countriesBlacklist\n        }\n        break;\n      case 'closeToAll':\n        setting.target_audience.audience_type = 'none'\n        break;\n    }\n\n    return setting;\n  }\n\n  setTargetAudience() {\n    const url = `https://graph.facebook.com/v2.7/me/messenger_profile?access_token=${this.config.accessToken}`\n    var setting = this.createTargetAudienceSetting();\n\n    return this.sendRequest(setting, 'messenger_profile', 'POST')\n  }\n\n  async setWhitelistedDomains(domains, chatExtensionHomeUrl) {\n    // the chat extension home url is controlled by a different state value\n    // but it still needs to be whitelisted.  It's also possible that this url\n    // has already been whitelisted for another purpose\n    // so we need to check:\n    //    a) that it's set, and\n    //    b) that it's not already in the list\n    if(!_.isEmpty(chatExtensionHomeUrl)) {\n      if(domains.indexOf(chatExtensionHomeUrl) == -1) {\n        domains.push(chatExtensionHomeUrl);\n      }\n    }\n\n    const url = `https://graph.facebook.com/v2.6/me/messenger_profile?access_token=${this.config.accessToken}`\n\n    await fetch(url, {\n      method: 'DELETE',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        fields: [\n          'whitelisted_domains'\n        ]\n      })\n    })\n    .then(this._handleFacebookResponse)\n\n    if (domains.length === 0) {\n      return\n    }\n\n    return fetch(url, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        whitelisted_domains: domains\n      })\n    })\n    .then(this._handleFacebookResponse)\n  }\n\n  setGreetingText(text) {\n    return this.sendThreadRequest({\n      setting_type: 'greeting',\n      greeting: { text }\n    })\n  }\n\n  deleteGreetingText() {\n    return this.sendThreadRequest({\n      setting_type: 'greeting'\n    }, 'DELETE')\n  }\n\n  setGetStartedButton(action) {\n    const payload = (typeof action === 'string') ? action : 'GET_STARTED'\n    if (typeof action === 'function') {\n      this.on(`postback:${payload}`, action)\n    }\n    return this.sendThreadRequest({\n      setting_type: 'call_to_actions',\n      thread_state: 'new_thread',\n      call_to_actions: [ { payload } ]\n    })\n  }\n\n  deleteGetStartedButton() {\n    return this.sendThreadRequest({\n      setting_type: 'call_to_actions',\n      thread_state: 'new_thread'\n    }, 'DELETE')\n  }\n\n  setPersistentMenu(buttons, composerInputDisabled) {\n    const formattedButtons = this._formatButtons(buttons)\n    return this.sendRequest({\n      persistent_menu: [\n        { // TODO Allow setting multiple menues for different locales\n          locale: 'default',\n          composer_input_disabled: composerInputDisabled,\n          call_to_actions: buttons\n        }\n      ]\n    }, 'messenger_profile')\n  }\n\n  deletePersistentMenu() {\n    return this.sendRequest({\n      \"fields\":[ \"persistent_menu\" ]\n    }, 'messenger_profile', 'DELETE')\n  }\n\n  /**\n   * Create the settings to add a new chat extension home url\n   *\n   * Within the context of this app the \"show_share\" is a boolean\n   * but Facebook either wants a\n   */\n  createChatExtensionHomeUrlSetting(home_url, in_test, show_share) {\n    var show_string = \"hide\"\n    if (show_share == true){\n      show_string = \"show\"\n    }\n\n    return {\n      \"home_url\" : {\n        \"url\": home_url,\n        \"webview_height_ratio\": \"tall\",\n        \"in_test\":in_test,\n        \"webview_share_button\": show_string\n      }\n    }\n  }\n\n  deleteChatExtensionHomeUrlSetting() {\n    return {\n      \"fields\": [\n        \"home_url\"\n      ]\n    }\n  }\n\n  deleteChatExtensionHomeUrl() {\n    const url = `https://graph.facebook.com/v2.7/me/messenger_profile?access_token=${this.config.accessToken}`\n    var setting = this.deleteChatExtensionHomeUrlSetting();\n\n    return this.sendRequest(setting, 'messenger_profile', 'DELETE')\n  }\n\n  setChatExtensionHomeUrl(home_url, in_test, show_share) {\n    const url = `https://graph.facebook.com/v2.7/me/messenger_profile?access_token=${this.config.accessToken}`\n\n    var setting = this.createChatExtensionHomeUrlSetting(home_url, in_test, show_share)\n\n    return this.sendRequest(setting, 'messenger_profile', 'POST')\n  }\n\n  // add and delete payment testers from application\n  // https://developers.facebook.com/docs/messenger-platform/thread-settings/payment#payment_test_users\n  deletePaymentTesterSetting(tester) {\n    return {\n      \"setting_type\": \"payment\",\n      \"payment_dev_mode_action\": \"REMOVE\",\n      \"payment_testers\": [tester]\n    }\n  }\n  createPaymentTesterSetting() {\n    return {\n      \"setting_type\": \"payment\",\n      \"payment_dev_mode_action\": \"ADD\",\n      \"payment_testers\": this.config.paymentTesters\n    }\n  }\n\n  setPaymentTesters() {\n    if(this.config.paymentTesters.length == 0) {\n      return\n    }\n    const setting = this.createPaymentTesterSetting()\n    return this.sendThreadRequest(setting, \"POST\")\n\n  }\n  deletePaymentTester(tester) {\n    const setting = this.deletePaymentTesterSetting(tester)\n    return this.sendThreadRequest(setting, \"POST\")\n  }\n\n  getPageDetails(){\n    return this._getPage()\n  }\n\n  updateSettings() {\n    const updateGetStarted = () => this.config.displayGetStarted\n      ? this.setGetStartedButton()\n      : this.deleteGetStartedButton()\n\n    const updateGreetingText = () => _.isEmpty(this.config.greetingMessage)\n      ? this.deleteGreetingText()\n      : this.setGreetingText(this.config.greetingMessage)\n\n    const items = this._reformatPersistentMenuItems(this.config.persistentMenuItems)\n    const updatePersistentMenu = () => this.config.persistentMenu\n      ? this.setPersistentMenu(items, this.config.composerInputDisabled)\n      : this.deletePersistentMenu()\n\n    const updateTargetAudience = () => this.setTargetAudience()\n\n    const updateTrustedDomains = () => this.setWhitelistedDomains(this.config.trustedDomains, this.config.chatExtensionHomeUrl)\n\n    const updateChatExtensionHomeUrl = () => _.isEmpty(this.config.chatExtensionHomeUrl) ? this.deleteChatExtensionHomeUrl() : this.setChatExtensionHomeUrl(this.config.chatExtensionHomeUrl, this.config.chatExtensionInTest, this.config.chatExtensionShowShareButton)\n\n    const updatePaymentTesters = () => this.setPaymentTesters()\n\n    let thrown = false\n    const contextifyError = (context) => (err) => {\n      if (thrown) throw err\n      const message = `Error setting ${context}\\n${err.message}`\n      thrown = true\n      throw new Error(message)\n    }\n\n    return updateGetStarted()\n    .catch(contextifyError('get started'))\n    .then(updateGreetingText)\n    .catch(contextifyError('greeting text'))\n    .then(updatePersistentMenu)\n    .catch(contextifyError('persistent menu'))\n    .then(updateTargetAudience)\n    .catch(contextifyError('target audience'))\n    .then(updateTrustedDomains)\n    .catch(contextifyError('trusted domains'))\n    .then(updateChatExtensionHomeUrl)\n    .catch(contextifyError('chat extensions'))\n    .then(updatePaymentTesters)\n    .catch(contextifyError('payment testers'))\n\n  }\n\n  module(factory) {\n    return factory.apply(this, [ this ])\n  }\n\n  _formatButtons(buttons) {\n    return buttons && buttons.map((button) => {\n      if (typeof button === 'string') {\n        return {\n          type: 'postback',\n          title: button,\n          payload: 'BUTTON_' + normalizeString(button)\n        }\n      } else if (button && button.title) {\n        return button\n      }\n      return {}\n    })\n  }\n\n  _formatQuickReplies(quickReplies) {\n    return quickReplies && quickReplies.map((reply) => {\n      if (typeof reply === 'string') {\n        return {\n          content_type: 'text',\n          title: reply,\n          payload: 'QR_' + normalizeString(reply)\n        }\n      } else if (reply && reply.title) {\n        return {\n          content_type: reply.content_type || 'text',\n          title: reply.title,\n          payload: reply.payload || 'QR_' + normalizeString(reply.title),\n          image_url: reply.image_url\n        }\n      }\n      return reply\n    })\n  }\n\n  _handleEvent(type, event) {\n    this.emit(type, event)\n  }\n\n  _handleMessageEvent(event) {\n    const text = event.message.text\n    if (!text) { return }\n\n    this._handleEvent('message', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handleAttachmentEvent(event) {\n    this._handleEvent('attachment', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handlePostbackEvent(event) {\n    const payload = event.postback.payload\n    if (payload) {\n      this._handleEvent(`postback:${payload}`, event)\n    }\n    this._handleEvent('postback', event)\n  }\n\n  _handleQuickReplyEvent(event) {\n    const payload = event.message.quick_reply && event.message.quick_reply.payload\n    if (payload) {\n      this._handleEvent(`quick_reply:${payload}`, event)\n    }\n    this._handleEvent('quick_reply', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handleFacebookResponse(res) {\n    if (!res) return\n\n    if (res.status < 400) {\n      return res\n    }\n\n    let errorMessage = 'An error has been returned by Facebook API.'\n    errorMessage += '\\nStatus: ' + res.status + ' (' + res.statusText + ')'\n\n    return Promise.resolve(true)\n    .then(() => res.json())\n    .then(json => {\n      errorMessage += '\\n' + json.error.message\n    })\n    .finally(() => {\n      throw new Error(errorMessage)\n    })\n  }\n\n  _initWebhook() {\n    this.app.get('/webhook', (req, res) => {\n      if (req.query['hub.mode'] === 'subscribe' && req.query['hub.verify_token'] === this.config.verifyToken) {\n\n        res.status(200).send(req.query['hub.challenge'])\n      } else {\n        console.error('Failed validation. Make sure the validation tokens match.')\n        res.sendStatus(403)\n      }\n    })\n\n    this.app.post('/webhook', (req, res) => {\n      var data = req.body\n      if (data.object !== 'page') {\n        return\n      }\n\n      this._handleEvent('raw_webhook_body', data)\n\n      // Iterate over each entry. There may be multiple if batched.\n      data.entry.forEach((entry) => {\n        if (entry && !entry.messaging) {\n          return\n        }\n        // Iterate over each messaging event\n        entry.messaging.forEach((event) => {\n          if (event.message && event.message.is_echo && !this.config.broadcastEchoes) {\n            return\n          }\n          if (event.message && event.message.text) {\n            if (event.message.quick_reply) {\n              this._handleQuickReplyEvent(event)\n            } else {\n              this._handleMessageEvent(event)\n            }\n          } else if (event.message && event.message.attachments) {\n            this._handleAttachmentEvent(event)\n          } else if (event.postback) {\n            this._handlePostbackEvent(event)\n          } else if (event.delivery) {\n            this._handleEvent('delivery', event)\n          } else if (event.read) {\n            this._handleEvent('read', event)\n          } else if (event.account_linking) {\n            this._handleEvent('account_linking', event)\n          } else if (event.optin) {\n            this._handleEvent('optin', event)\n          } else if (event.referral) {\n            this._handleEvent('referral', event)\n          } else if (event.payment){\n            this._handleEvent('payment', event)\n          }\n          else {\n            console.log('Webhook received unknown event: ', event)\n          }\n        })\n      })\n\n      // Must send back a 200 within 20 seconds or the request will time out.\n      res.sendStatus(200)\n    })\n  }\n\n  _verifyRequestSignature(req, res, buf) {\n    if (!/^\\/webhook/i.test(req.path)) {\n      return\n    }\n\n    var signature = req.headers['x-hub-signature']\n    if (!signature) {\n      throw new Error('Couldn\\'t validate the request signature.')\n    } else {\n      let [, hash] = signature.split('=')\n      var expectedHash = crypto.createHmac('sha1', this.config.appSecret).update(buf).digest('hex')\n\n      if (hash != expectedHash) {\n        throw new Error('Couldn\\'t validate the request signature.')\n      }\n    }\n  }\n\n  _reformatPersistentMenuItems() {\n    if (this.config.persistentMenu && this.config.persistentMenuItems) {\n      return this.config.persistentMenuItems.map((item) => {\n\n        if (item.value && item.type === 'postback') {\n          item.payload = item.value\n          delete item.value\n        } else if (item.value && item.type === 'url') {\n          item.url = item.value\n          item.type = 'web_url'\n          delete item.value\n        }\n        return item\n      })\n    }\n  }\n\n  _setupNewWebhook() {\n    const oAuthUrl = 'https://graph.facebook.com/v2.7/oauth/access_token' +\n      '?client_id=' + this.config.applicationID +\n      '&client_secret=' + this.config.appSecret +\n      '&grant_type=client_credentials'\n\n    const url = `https://graph.facebook.com/v2.7/${this.config.applicationID}/subscriptions?access_token=`\n\n    return fetch(oAuthUrl)\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .then(json => json.access_token)\n    .then(token => fetch(url + token, {\n      method: 'POST',\n      headers: {'Content-Type': 'application/json'},\n      body: JSON.stringify({\n        object: 'page',\n        callback_url: 'https://' + this.config.hostname + '/api/botpress-messenger/webhook',\n        verify_token: this.config.verifyToken,\n        fields: this.config.webhookSubscriptionFields\n      })\n    }))\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n  }\n\n  _subscribePage() {\n    const url = 'https://graph.facebook.com/v2.6/me/subscribed_apps?access_token=' + this.config.accessToken\n\n    return fetch(url, { method: 'POST' })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .catch(err => console.log(err))\n  }\n\n  _unsubscribePage() {\n    const url = 'https://graph.facebook.com/v2.6/me/subscribed_apps?access_token=' + this.config.accessToken\n\n    return fetch(url, { method: 'DELETE' })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .catch(err => console.log(err))\n  }\n\n  _getPage() {\n    const url = 'https://graph.facebook.com/v2.6/me/?access_token=' + this.config.accessToken\n\n    return fetch(url, { method: 'GET' })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .catch(err => console.log(err))\n  }\n\n}\n\nmodule.exports = Messenger\n\n\n\n// WEBPACK FOOTER //\n// ./src/messenger.js","import { DatabaseHelpers } from 'botpress'\n\nvar knex = null\n\nfunction initialize() {\n  if (!knex) {\n    throw new Error('you must initialize the database before')\n  }\n  \n  return DatabaseHelpers(knex).createTableIfNotExists('messenger_attachments', function (table) {\n    table.string('url').primary()\n    table.string('attachment_id')\n  }).then()\n}\n\nfunction addAttachment(url, attachment_id) {\n  return knex('messenger_attachments')\n  .insert({ url, attachment_id })\n  .then().get(0)\n}\n\nfunction getAttachment(url) {\n  return knex('messenger_attachments')\n  .where('url', url)\n  .select('attachment_id')\n  .then().get(0)\n  .then(ret => {\n    return ret && ret.attachment_id\n  })\n}\n\nfunction hasAttachment(url) {\n  return knex('messenger_attachments')\n  .where('url', url)\n  .count('url as count')\n  .then(ret => {\n    return ret && ret[0] && ret[0].count === 1\n  })\n}\n\nmodule.exports = (k) => {\n  knex = k\n  return { initialize, addAttachment, getAttachment, hasAttachment }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 13\n// module chunks = 0","module.exports = require(\"eventemitter2\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"eventemitter2\"\n// module id = 14\n// module chunks = 0","module.exports = require(\"crypto\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"crypto\"\n// module id = 15\n// module chunks = 0","module.exports = require(\"node-fetch\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"node-fetch\"\n// module id = 16\n// module chunks = 0","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 17\n// module chunks = 0","import LRU from 'lru-cache'\n\nimport Users from './users'\nimport outgoing from './outgoing'\nimport _ from 'lodash'\n\nmodule.exports = (bp, messenger) => {\n\n  const users = Users(bp, messenger)\n\n  const messagesCache = LRU({\n    max: 10000,\n    maxAge: 60 * 60 * 1000\n  })\n\n  const preprocessEvent = payload => {\n    const userId = payload.sender && payload.sender.id\n    const mid = payload.message && payload.message.mid\n\n    if (mid && !messagesCache.has(mid)) {\n      // We already processed this message\n      payload.alreadyProcessed = true\n    } else {\n      // Mark it as processed\n      messagesCache.set(mid, true)\n    }\n\n    return users.getOrFetchUserProfile(userId)\n  }\n\n  messenger.on('message', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      // push the message to the incoming middleware\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'message',\n        user: profile,\n        text: e.message.text,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('attachment', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'attachments',\n        user: profile,\n        text: e.message.attachments.length + ' attachments',\n        raw: e\n      })\n      e.message.attachments.forEach(att => {\n        bp.middlewares.sendIncoming({\n          platform: 'facebook',\n          type: att.type,\n          user: profile,\n          text: att.payload.url ?\n            att.payload.url\n            : JSON.stringify(att.payload),\n          raw: att\n        })\n      })\n    })\n  })\n\n  messenger.on('postback', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'postback',\n        user: profile,\n        text: e.postback.payload,\n        raw: e\n      })\n\n      if (e.postback.payload === 'GET_STARTED') {\n        const mConfig = messenger.getConfig()\n\n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponseText') {\n          bp.messenger.sendText(profile.id, mConfig.autoResponseText)\n        }\n        \n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponsePostback') {\n          bp.middlewares.sendIncoming({\n            platform: 'facebook',\n            type: 'postback',\n            user: profile,\n            text: mConfig.autoResponsePostback,\n            raw: e\n          })\n        }\n      }\n    })\n  })\n\n  messenger.on('quick_reply', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'quick_reply',\n        user: profile,\n        text: e.message.quick_reply.payload,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('delivery', e => {\n\n    _.values(outgoing.pending).forEach(pending => {\n      const recipient = pending.event.raw.to\n      if (e.sender.id === recipient && pending.event.raw.waitDelivery) {\n        if (_.includes(e.delivery.mids, pending.mid)) {\n          pending.resolve(e)\n          delete outgoing.pending[pending.event.__id]\n        }\n      }\n    })\n\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'delivery',\n        user: profile,\n        text: e.delivery.watermark.toString(),\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('read', e => {\n    _.values(outgoing.pending).forEach(pending => {\n      const recipient = pending.event.raw.to\n      if (e.sender.id === recipient) {\n        if (pending.event.raw.waitRead\n          && pending.timestamp\n          && pending.timestamp <= e.read.watermark) {\n            pending.resolve(e)\n            delete outgoing.pending[pending.event.__id]\n        }\n      }\n    })\n\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'read',\n        user: profile,\n        text: e.read.watermark.toString(),\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('account_linking', e => {\n      preprocessEvent(e)\n        .then(profile => {\n          bp.middlewares.sendIncoming({\n              platform: 'facebook',\n              type: 'account_linking',\n              user: profile,\n              text: e.account_linking.authorization_code,\n              raw: e\n          })\n      })\n  })\n\n  messenger.on('optin', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'optin',\n        user: profile,\n        text: e.optin.ref,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('referral', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'referral',\n        user: profile,\n        text: e.referral.ref,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('payment', e=> {\n    preprocessEvent(e)\n    .then(profile=> {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'payment',\n        text: 'payment',\n        user: profile,\n        payment: e.payment,\n        raw: e\n      })\n    })\n  })\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/incoming.js","module.exports = require(\"lru-cache\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lru-cache\"\n// module id = 19\n// module chunks = 0","import util from 'util'\nimport _ from 'lodash'\n\nimport actions from './actions'\n\nconst QUICK_REPLY_PAYLOAD = /\\<(.+)\\>\\s(.+)/i\n\nfunction processButtons(buttons, blocName) {\n  return processQuickReplies(buttons, blocName).map(button => {\n    if (button.payload && button.title && _.isNil(button.type)) {\n      return Object.assign(button, { type: 'postback' })\n    }\n\n    return button\n  })\n}\n\nfunction processQuickReplies(qrs, blocName) {\n  if (!_.isArray(qrs)) {\n    throw new Error('Expected quick_replies to be an array')\n  }\n\n  return qrs.map(qr => {\n    if (_.isString(qr) && QUICK_REPLY_PAYLOAD.test(qr)) {\n      let [, payload, text] = QUICK_REPLY_PAYLOAD.exec(qr)\n      \n      // <.HELLO> becomes <BLOCNAME.HELLO>\n      if (payload.startsWith('.')) {\n        payload = blocName + payload\n      }\n\n      return {\n        title: text,\n        payload: payload.toUpperCase()\n      }\n    }\n\n    return qr\n  })\n}\n\nfunction amendButtons(obj, blocName) {\n  if (!_.isPlainObject(obj)) {\n    return obj\n  }\n\n  return _.mapValues(obj, (value, key) => {\n    if (_.isPlainObject(value)) {\n      return amendButtons(value, blocName)\n    } else if (_.isArray(value)) {\n      if (key === 'buttons') {\n        return amendButtons(processButtons(value, blocName))\n      }\n      return value.map(v => amendButtons(v, blocName))\n    } else {\n      return value\n    }\n  })\n}\n\nfunction getUserId(event) {\n  let userId = _.get(event, 'user.userId')\n    || _.get(event, 'raw.userId')\n    || _.get(event, 'userId')\n    || _.get(event, 'raw.from')\n    || _.get(event, 'user.id')\n    || _.get(event, 'raw.user.id')\n\n  if (!userId) {\n    throw new Error('Could not find userId in the incoming event.')\n  }\n\n  if (userId.startsWith('facebook:')) {\n    return userId.substr('facebook:'.length)\n  }\n\n  return userId\n}\n\nfunction processOutgoing({ event, blocName, instruction }) {\n  const ins = Object.assign({}, instruction) // Create a shallow copy of the instruction\n\n  ////////\n  // PRE-PROCESSING\n  ////////\n  \n  const optionsList = [\n    'quick_replies', \n    'waitRead', \n    'waitDelivery', \n    'typing', \n    'tag',\n    '__platformSpecific',\n    'on'\n  ]\n\n  const options = _.pick(instruction, optionsList)\n  \n  for (let prop of optionsList) {\n    delete ins[prop]\n  }\n\n  if (options.quick_replies) {\n    options.quick_replies = processQuickReplies(options.quick_replies, blocName)\n  }\n\n  /////////\n  /// Processing\n  /////////\n  \n  if (!_.isNil(instruction.template_type)) {\n    const data = amendButtons(ins, blocName)\n    return actions.createTemplate(getUserId(event), data, options)\n  }\n\n  for (let attr of ['image', 'audio', 'video', 'file']) {\n    if (!_.isNil(instruction[attr])) {\n      return actions.createAttachment(getUserId(event), attr, ins[attr], options)\n    }\n  }\n\n  if (!_.isNil(instruction.attachment)) {\n    return actions.createAttachment(\n      getUserId(event),\n      instruction.type || instruction.attachment,\n      ins.url || instruction.attachment,\n      options)\n  }\n\n  if (!_.isNil(instruction.text)) {\n    return actions.createText(getUserId(event), instruction.text, options)\n  }\n\n  ////////////\n  /// POST-PROCESSING\n  ////////////\n  \n  // Nothing to post-process yet\n\n  ////////////\n  /// INVALID INSTRUCTION\n  ////////////\n\n  const strRep = util.inspect(instruction, false, 1)\n  throw new Error(`Unrecognized instruction on Facebook Messenger in bloc '${blocName}': ${strRep}`)\n}\n\n////////////\n/// TEMPLATES\n////////////\n\nfunction getTemplates() {\n  return [\n    {\n      type: 'Text - Single message',\n      template: 'block_name_sm:\\n\\  - Text goes here..'\n    },{\n      type: 'Text - Multiple messages',\n      template: 'block_name_mm:\\n  - Text goes here..(1)\\n  - Text goes here..(2)'\n    },{\n      type: 'Text - Random message',\n      template: 'block_name_rm:\\n  - text:\\n    - Text goes here..(1)\\n    - Text goes here..(2)'\n    },{\n      type: 'Typing - Message with typing',\n      template: 'block_name_bm:\\n  - text: Text goes here..(1)\\n    typing: 1000ms'\n    },{\n      type: 'Text - Quick replies',\n      template: 'block_name_qr:\\n  - text: Text goes here..\\n    quick_replies:\\n    - <POSTBACK_1> Button..(1)\\n    - <POSTBACK_2> Button..(2)'\n    },{\n      type: 'Attachment - Image',\n      template: 'block_image:\\n  - on: facebook\\n    image: https://botpress.io/static/img/nobg_primary_black.png'\n    },{\n      type: 'Attachment - Video',\n      template: 'block_video:\\n  - on: facebook\\n    video: https://www.youtube.com/watch?v=QIokUU4HAKU'\n    },{\n      type: 'Template - Generic',\n      template: 'block_generic:\\n  - on: facebook\\n    template_type: generic\\n    elements:\\n    - title: Welcome to Botpress\\n      image_url: https://botpress.io/static/img/grey_bg_primary.png\\n      subtitle: This is a great building framework\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Random cat videos\\n      - type: postback\\n        title: This button gives the same thing\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Cats on Youtube'\n    },{\n      type: 'Template - Carousel',\n      template: 'block_carousel:\\n  - on: facebook\\n    template_type: generic\\n    elements:\\n    - title: Welcome to Botpress\\n      image_url: https://botpress.io/static/img/grey_bg_primary.png\\n      subtitle: This is a great building framework\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Random cat videos\\n      - type: postback\\n        title: This button gives the same thing\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Cats on Youtube\\n    - title: Bienvenido a Botpress\\n      image_url: https://botpress.io/static/img/nobg_primary_black.png\\n      subtitle: Este es un gran marco de construcción\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Videos de perros al azar\\n      - type: postback\\n        title: Este botón da lo mismo\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Gatos en Youtube'\n    } \n  ]\n}\n\nmodule.exports = bp => {\n  const [umm, registerConnector] = _.at(bp, ['umm', 'umm.registerConnector'])\n\n  umm && registerConnector && registerConnector({\n    platform: 'facebook',\n    processOutgoing: args => processOutgoing(Object.assign({}, args, { bp })),\n    templates: getTemplates()\n  })\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/umm.js","module.exports = require(\"util\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"util\"\n// module id = 21\n// module chunks = 0","module.exports = \"# Edit this file to set the Messenger's module settings programmatically instead of using the GUI\\n# This is regular YAML syntax. See http://docs.ansible.com/ansible/YAMLSyntax.html\\n# You can override these settings with ENV variables. They are commented below.\\n\\n# hostname: \\\"\\\" # MESSENGER_HOST\\n\\n# applicationID: \\\"\\\" # MESSENGER_APP_ID\\n# accessToken: \\\"\\\" # MESSENGER_ACCESS_TOKEN\\n# appSecret: \\\"\\\" # MESSENGER_APP_SECRET\\n\\n# verifyToken: \\\"\\\" # MESSENGER_VERIFY_TOKEN\\n\\n# displayGetStarted: true\\n# greetingMessage: \\\"\\\"\\n\\n# https://developers.facebook.com/docs/messenger-platform/messenger-profile/persistent-menu\\n# persistentMenuItems: []\\n\\n# targetAudience: openToAll\\n# targetAudienceOpenToSome: \\\"\\\"\\n# targetAudienceCloseToSome: \\\"\\\"\\n\\n# trustedDomains: []\\n# autoRespondGetStarted: true\\n\\n# paymentTesters: []\\n\\n# chatExtensionHomeUrl: \\\"\\\"\\n# chatExtensionInTest: true\\n# chatExtensionShowShareButton: false\\n\\nenabled: true\"\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/raw-loader!./src/botpress-messenger.config.yml\n// module id = 22\n// module chunks = 0"],"sourceRoot":""}